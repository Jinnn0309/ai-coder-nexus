# Nexus AI Platform - æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´12æœˆ2æ—¥  
**ä½œè€…**: æŠ€æœ¯å›¢é˜Ÿ  
**å®¡æ ¸äºº**: æ¶æ„å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº  

---

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£ç±»å‹** | æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£ |
| **é€‚ç”¨ç‰ˆæœ¬** | V1.0 - V2.0 |
| **ç›®æ ‡è¯»è€…** | åç«¯å·¥ç¨‹å¸ˆã€å‰ç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€DevOpså·¥ç¨‹å¸ˆ |
| **å…³è”æ–‡æ¡£** | APIæ¥å£æ–‡æ¡£ã€æ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€éƒ¨ç½²æŒ‡å— |

---

## 1. æ¶æ„æ¦‚è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[Webæµè§ˆå™¨] --> B[ç§»åŠ¨ç«¯æµè§ˆå™¨]
    end
    
    subgraph "CDNå±‚"
        C[é™æ€èµ„æºCDN]
        D[APIç½‘å…³]
    end
    
    subgraph "åº”ç”¨å±‚"
        E[å‰ç«¯åº”ç”¨<br/>React + TS]
        F[è´Ÿè½½å‡è¡¡å™¨]
    end
    
    subgraph "æœåŠ¡å±‚"
        G[ç”¨æˆ·æœåŠ¡<br/>Node.js]
        H[æ¨¡æ¿æœåŠ¡<br/>Node.js]
        I[æç¤ºè¯æœåŠ¡<br/>Node.js]
        J[AIé›†æˆæœåŠ¡<br/>Node.js]
        K[åˆ†ææœåŠ¡<br/>Node.js]
    end
    
    subgraph "AIæœåŠ¡å±‚"
        L[Gemini API]
        M[OpenAI API]
        N[æœ¬åœ°æ¨¡å‹æœåŠ¡]
    end
    
    subgraph "æ•°æ®å±‚"
        O[PostgreSQL<br/>ä¸»æ•°æ®åº“]
        P[Redis<br/>ç¼“å­˜]
        Q[Elasticsearch<br/>æœç´¢]
        R[MinIO<br/>æ–‡ä»¶å­˜å‚¨]
    end
    
    subgraph "ç›‘æ§å±‚"
        S[æ—¥å¿—æ”¶é›†]
        T[æŒ‡æ ‡ç›‘æ§]
        U[é“¾è·¯è¿½è¸ª]
    end
    
    A --> C
    B --> C
    A --> D
    B --> D
    C --> E
    D --> F
    F --> G
    F --> H
    F --> I
    F --> J
    F --> K
    J --> L
    J --> M
    J --> N
    G --> O
    H --> O
    I --> O
    G --> P
    H --> P
    I --> P
    J --> Q
    K --> Q
    H --> R
    I --> R
    G --> S
    H --> S
    I --> S
    J --> S
    K --> S
    G --> T
    H --> T
    I --> T
    J --> T
    K --> T
    G --> U
    H --> U
    I --> U
    J --> U
    K --> U
```

### 1.2 æ¶æ„åŸåˆ™

#### 1.2.1 è®¾è®¡åŸåˆ™
- **å¾®æœåŠ¡æ¶æ„**: æœåŠ¡æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- **é«˜å¯ç”¨æ€§**: æ— å•ç‚¹æ•…éšœï¼Œæ”¯æŒæ•…éšœè‡ªåŠ¨è½¬ç§»
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³å’Œå‚ç›´æ‰©å±•
- **å®‰å…¨æ€§**: å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œæ•°æ®åŠ å¯†ä¼ è¾“å­˜å‚¨
- **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—å’Œé“¾è·¯è¿½è¸ª

#### 1.2.2 æŠ€æœ¯é€‰å‹åŸåˆ™
- **æˆç†Ÿç¨³å®š**: é€‰æ‹©ç»è¿‡éªŒè¯çš„æŠ€æœ¯æ ˆ
- **ç¤¾åŒºæ´»è·ƒ**: æ‹¥æœ‰æ´»è·ƒçš„å¼€æºç¤¾åŒºæ”¯æŒ
- **å­¦ä¹ æˆæœ¬**: å›¢é˜ŸæŠ€æœ¯æ ˆåŒ¹é…ï¼Œå­¦ä¹ æˆæœ¬å¯æ§
- **ç”Ÿæ€ä¸°å¯Œ**: é…å¥—å·¥å…·å’Œç¬¬ä¸‰æ–¹æœåŠ¡ä¸°å¯Œ

### 1.3 æ¶æ„åˆ†å±‚

#### 1.3.1 æ¥å…¥å±‚ (Access Layer)
**èŒè´£**: å¤„ç†å¤–éƒ¨è¯·æ±‚æ¥å…¥å’Œè·¯ç”±åˆ†å‘

**ç»„ä»¶**:
- CDN: é™æ€èµ„æºåŠ é€Ÿåˆ†å‘
- APIç½‘å…³: ç»Ÿä¸€å…¥å£ã€è®¤è¯æˆæƒã€é™æµç†”æ–­
- è´Ÿè½½å‡è¡¡å™¨: è¯·æ±‚åˆ†å‘å’Œå¥åº·æ£€æŸ¥

#### 1.3.2 åº”ç”¨å±‚ (Application Layer)
**èŒè´£**: ä¸šåŠ¡é€»è¾‘å¤„ç†å’Œæ•°æ®æµè½¬

**ç»„ä»¶**:
- å‰ç«¯åº”ç”¨: React + TypeScriptå•é¡µåº”ç”¨
- å¾®æœåŠ¡: æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†çš„æœåŠ¡é›†ç¾¤

#### 1.3.3 æ•°æ®å±‚ (Data Layer)
**èŒè´£**: æ•°æ®å­˜å‚¨ã€æ£€ç´¢å’Œç®¡ç†

**ç»„ä»¶**:
- å…³ç³»æ•°æ®åº“: PostgreSQLä¸»æ•°æ®åº“
- ç¼“å­˜æœåŠ¡: Rediså†…å­˜ç¼“å­˜
- æœç´¢å¼•æ“: Elasticsearchå…¨æ–‡æœç´¢
- å¯¹è±¡å­˜å‚¨: MinIOæ–‡ä»¶å­˜å‚¨

---

## 2. å‰ç«¯æ¶æ„è®¾è®¡

### 2.1 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|----------|
| **React** | 19.2.0 | UIæ¡†æ¶ | ç»„ä»¶åŒ–ã€ç”Ÿæ€ä¸°å¯Œã€æ€§èƒ½ä¼˜ç§€ |
| **TypeScript** | 5.8.2 | ç±»å‹å®‰å…¨ | æå‡ä»£ç è´¨é‡ã€å‡å°‘è¿è¡Œæ—¶é”™è¯¯ |
| **Vite** | 6.2.0 | æ„å»ºå·¥å…· | å¿«é€Ÿå¼€å‘ã€çƒ­æ›´æ–°ã€ç°ä»£åŒ– |
| **Tailwind CSS** | 3.4+ | CSSæ¡†æ¶ | åŸå­åŒ–ã€é«˜æ•ˆå¼€å‘ã€ä¸€è‡´æ€§ |
| **React Router** | 6.8+ | è·¯ç”±ç®¡ç† | å£°æ˜å¼è·¯ç”±ã€ä»£ç åˆ†å‰² |
| **React Query** | 4.0+ | çŠ¶æ€ç®¡ç† | æœåŠ¡ç«¯çŠ¶æ€ç®¡ç†ã€ç¼“å­˜ |
| **Zustand** | 4.4+ | å®¢æˆ·ç«¯çŠ¶æ€ | è½»é‡çº§çŠ¶æ€ç®¡ç† |
| **Lucide React** | 0.554+ | å›¾æ ‡åº“ | ç°ä»£åŒ–ã€å›¾æ ‡ä¸°å¯Œã€TypeScriptæ”¯æŒ |

### 2.2 é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ components/           # é€šç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ ui/              # UIåŸºç¡€ç»„ä»¶
â”‚   â”œâ”€â”€ layout/          # å¸ƒå±€ç»„ä»¶
â”‚   â””â”€â”€ common/          # ä¸šåŠ¡é€šç”¨ç»„ä»¶
â”œâ”€â”€ pages/               # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ Dashboard/       # ä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ Process/         # AIç¼–ç¨‹æµç¨‹
â”‚   â”œâ”€â”€ Library/         # æç¤ºè¯åº“
â”‚   â”œâ”€â”€ Playground/      # AIæµ‹è¯•åœº
â”‚   â””â”€â”€ Guides/          # å·¥å…·æŒ‡å—
â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰Hook
â”œâ”€â”€ services/            # APIæœåŠ¡å±‚
â”œâ”€â”€ store/               # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”œâ”€â”€ types/               # ç±»å‹å®šä¹‰
â”œâ”€â”€ constants/           # å¸¸é‡å®šä¹‰
â”œâ”€â”€ styles/              # æ ·å¼æ–‡ä»¶
â””â”€â”€ assets/              # é™æ€èµ„æº
```

### 2.3 ç»„ä»¶æ¶æ„

#### 2.3.1 ç»„ä»¶å±‚æ¬¡ç»“æ„

```typescript
// åº”ç”¨æ ¹ç»„ä»¶
App
â”œâ”€â”€ RouterProvider       # è·¯ç”±æä¾›è€…
â”œâ”€â”€ QueryClientProvider   # React Queryæä¾›è€…
â”œâ”€â”€ ThemeProvider        # ä¸»é¢˜æä¾›è€…
â””â”€â”€ I18nextProvider      # å›½é™…åŒ–æä¾›è€…
    â””â”€â”€ Layout
        â”œâ”€â”€ Header       # å¤´éƒ¨å¯¼èˆª
        â”œâ”€â”€ Sidebar      # ä¾§è¾¹æ 
        â””â”€â”€ Main
            â””â”€â”€ Page      # é¡µé¢ç»„ä»¶
                â”œâ”€â”€ PageHeader
                â”œâ”€â”€ PageContent
                â””â”€â”€ PageFooter
```

#### 2.3.2 ç»„ä»¶è®¾è®¡åŸåˆ™

**å•ä¸€èŒè´£åŸåˆ™**
```typescript
// âœ… å¥½çš„è®¾è®¡ - å•ä¸€èŒè´£
const TemplateCard = ({ template, onUse, onFavorite }) => {
  return (
    <Card>
      <CardHeader title={template.title} />
      <CardBody description={template.description} />
      <CardActions onUse={onUse} onFavorite={onFavorite} />
    </Card>
  );
};

// âŒ é¿å…çš„è®¾è®¡ - èŒè´£è¿‡å¤š
const TemplateComplex = ({ template, user, comments, analytics }) => {
  // åŒ…å«æ¨¡æ¿å±•ç¤ºã€ç”¨æˆ·ä¿¡æ¯ã€è¯„è®ºã€ç»Ÿè®¡ç­‰å¤šç§èŒè´£
};
```

**ç»„ä»¶ç»„åˆä¼˜äºç»§æ‰¿**
```typescript
// âœ… å¥½çš„è®¾è®¡ - ç»„ä»¶ç»„åˆ
const TemplateList = ({ templates, filters, onFilterChange }) => {
  return (
    <div>
      <FilterPanel filters={filters} onChange={onFilterChange} />
      <TemplateGrid templates={templates} />
      <Pagination total={templates.length} />
    </div>
  );
};
```

### 2.4 çŠ¶æ€ç®¡ç†æ¶æ„

#### 2.4.1 çŠ¶æ€åˆ†ç±»

**å®¢æˆ·ç«¯çŠ¶æ€ (Client State)**
```typescript
// ä½¿ç”¨Zustandç®¡ç†
interface AppState {
  // UIçŠ¶æ€
  sidebarCollapsed: boolean;
  currentTheme: 'light' | 'dark';
  currentLanguage: string;
  
  // ç”¨æˆ·åå¥½
  favoriteTemplates: string[];
  recentTemplates: string[];
  
  // ä¸´æ—¶çŠ¶æ€
  selectedFilters: FilterState;
  searchQuery: string;
}

const useAppStore = create<AppState>((set, get) => ({
  sidebarCollapsed: false,
  currentTheme: 'light',
  currentLanguage: 'en',
  favoriteTemplates: [],
  recentTemplates: [],
  selectedFilters: {},
  searchQuery: '',
  
  actions: {
    toggleSidebar: () => set(state => ({ 
      sidebarCollapsed: !state.sidebarCollapsed 
    })),
    
    addFavorite: (templateId: string) => set(state => ({
      favoriteTemplates: [...state.favoriteTemplates, templateId]
    }))
  }
}));
```

**æœåŠ¡ç«¯çŠ¶æ€ (Server State)**
```typescript
// ä½¿ç”¨React Queryç®¡ç†
export const useTemplates = (filters?: TemplateFilters) => {
  return useQuery({
    queryKey: ['templates', filters],
    queryFn: () => templateService.getTemplates(filters),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
    cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿ
  });
};

export const useCreateTemplate = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: templateService.createTemplate,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['templates'] });
    }
  });
};
```

#### 2.4.2 çŠ¶æ€æµè½¬å›¾

```mermaid
graph LR
    A[ç”¨æˆ·æ“ä½œ] --> B[Actionè§¦å‘]
    B --> C{çŠ¶æ€ç±»å‹}
    C -->|å®¢æˆ·ç«¯çŠ¶æ€| D[Zustand Store]
    C -->|æœåŠ¡ç«¯çŠ¶æ€| E[React Query]
    D --> F[UIé‡æ–°æ¸²æŸ“]
    E --> G[APIè¯·æ±‚]
    G --> H[åç«¯å“åº”]
    H --> E
    E --> F
```

### 2.5 è·¯ç”±æ¶æ„

#### 2.5.1 è·¯ç”±é…ç½®

```typescript
// è·¯ç”±å®šä¹‰
const routes = [
  {
    path: '/',
    element: <Layout />,
    children: [
      {
        index: true,
        element: <Navigate to="/dashboard" replace />
      },
      {
        path: 'dashboard',
        element: <Dashboard />,
        loader: dashboardLoader
      },
      {
        path: 'process',
        element: <ProcessNavigator />,
        children: [
          {
            path: ':stage',
            element: <StageTemplateList />,
            loader: stageTemplateLoader
          }
        ]
      },
      {
        path: 'library',
        element: <Library />,
        loader: libraryLoader
      },
      {
        path: 'playground',
        element: <Playground />,
        action: playgroundAction
      },
      {
        path: 'guides',
        element: <GuideViewer />,
        loader: guidesLoader
      }
    ]
  },
  {
    path: '/auth',
    element: <AuthLayout />,
    children: [
      {
        path: 'login',
        element: <Login />,
        action: loginAction
      },
      {
        path: 'register',
        element: <Register />,
        action: registerAction
      }
    ]
  }
];
```

#### 2.5.2 ä»£ç åˆ†å‰²ç­–ç•¥

```typescript
// æ‡’åŠ è½½é¡µé¢ç»„ä»¶
const Dashboard = lazy(() => import('../pages/Dashboard'));
const ProcessNavigator = lazy(() => import('../pages/ProcessNavigator'));
const Library = lazy(() => import('../pages/Library'));
const Playground = lazy(() => import('../pages/Playground'));
const GuideViewer = lazy(() => import('../pages/GuideViewer'));

// è·¯ç”±ä¸­ä½¿ç”¨Suspense
<Suspense fallback={<PageLoading />}>
  <Routes>
    {/* è·¯ç”±é…ç½® */}
  </Routes>
</Suspense>
```

---

## 3. åç«¯æ¶æ„è®¾è®¡

### 3.1 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|----------|
| **Node.js** | 20.10+ | è¿è¡Œæ—¶ç¯å¢ƒ | é«˜æ€§èƒ½ã€ç”Ÿæ€ä¸°å¯Œã€TypeScriptæ”¯æŒ |
| **Express.js** | 4.18+ | Webæ¡†æ¶ | æˆç†Ÿç¨³å®šã€ä¸­é—´ä»¶ä¸°å¯Œã€ç¤¾åŒºæ´»è·ƒ |
| **TypeScript** | 5.8+ | ç±»å‹å®‰å…¨ | æå‡ä»£ç è´¨é‡ã€å‡å°‘è¿è¡Œæ—¶é”™è¯¯ |
| **Prisma** | 5.6+ | ORMå·¥å…· | ç±»å‹å®‰å…¨ã€è‡ªåŠ¨åŒ–è¿ç§»ã€æŸ¥è¯¢ä¼˜åŒ– |
| **Redis** | 7.2+ | ç¼“å­˜æ•°æ®åº“ | é«˜æ€§èƒ½ã€æ•°æ®ç»“æ„ä¸°å¯Œã€æŒä¹…åŒ– |
| **PostgreSQL** | 15+ | ä¸»æ•°æ®åº“ | ACIDç‰¹æ€§ã€JSONæ”¯æŒã€æ‰©å±•æ€§å¼º |
| **Elasticsearch** | 8.11+ | æœç´¢å¼•æ“ | å…¨æ–‡æœç´¢ã€å®æ—¶åˆ†æã€åˆ†å¸ƒå¼ |
| **MinIO** | 4.0+ | å¯¹è±¡å­˜å‚¨ | S3å…¼å®¹ã€å¼€æºã€é«˜æ€§èƒ½ |

### 3.2 å¾®æœåŠ¡æ¶æ„

#### 3.2.1 æœåŠ¡æ‹†åˆ†

```mermaid
graph TB
    subgraph "APIç½‘å…³"
        GW[Kong / Nginx]
    end
    
    subgraph "æ ¸å¿ƒæœåŠ¡"
        US[ç”¨æˆ·æœåŠ¡<br/>User Service]
        TS[æ¨¡æ¿æœåŠ¡<br/>Template Service]
        PS[æç¤ºè¯æœåŠ¡<br/>Prompt Service]
    end
    
    subgraph "æ”¯æ’‘æœåŠ¡"
        AS[AIé›†æˆæœåŠ¡<br/>AI Service]
        NS[é€šçŸ¥æœåŠ¡<br/>Notification Service]
        ASRV[åˆ†ææœåŠ¡<br/>Analytics Service]
    end
    
    subgraph "åŸºç¡€è®¾æ–½æœåŠ¡"
        FS[æ–‡ä»¶æœåŠ¡<br/>File Service]
        SS[æœç´¢æœåŠ¡<br/>Search Service]
        AS_AUTH[è®¤è¯æœåŠ¡<br/>Auth Service]
    end
    
    GW --> US
    GW --> TS
    GW --> PS
    GW --> AS
    GW --> NS
    GW --> ASRV
    GW --> FS
    GW --> SS
    GW --> AS_AUTH
    
    US --> AS_AUTH
    TS --> FS
    TS --> SS
    PS --> SS
    AS --> SS
```

#### 3.2.2 æœåŠ¡èŒè´£

**ç”¨æˆ·æœåŠ¡ (User Service)**
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¤è¯
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- æƒé™æ§åˆ¶å’Œè§’è‰²ç®¡ç†
- ç”¨æˆ·åå¥½è®¾ç½®

**æ¨¡æ¿æœåŠ¡ (Template Service)**
- æ¨¡æ¿CRUDæ“ä½œ
- æ¨¡æ¿åˆ†ç±»å’Œæ ‡ç­¾ç®¡ç†
- æ¨¡æ¿ä½¿ç”¨ç»Ÿè®¡
- æ¨¡æ¿è¯„ä»·å’Œè¯„è®º

**æç¤ºè¯æœåŠ¡ (Prompt Service)**
- æç¤ºè¯CRUDæ“ä½œ
- æç¤ºè¯åˆ†ç±»å’Œæœç´¢
- æ•ˆç‡è¯„åˆ†è®¡ç®—
- ä½¿ç”¨ç»Ÿè®¡å’Œåˆ†æ

**AIé›†æˆæœåŠ¡ (AI Service)**
- AIæ¨¡å‹è°ƒç”¨å°è£…
- ä»£ç åˆ†æå¤„ç†
- æ™ºèƒ½æ¨èç®—æ³•
- ç»“æœåå¤„ç†

### 3.3 æ•°æ®åº“è®¾è®¡

#### 3.3.1 æ•°æ®åº“é€‰æ‹©

**PostgreSQL - ä¸»æ•°æ®åº“**
**é€‰æ‹©ç†ç”±**:
- å¼ºå¤§çš„ACIDäº‹åŠ¡æ”¯æŒ
- ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ˆJSONã€Arrayç­‰ï¼‰
- ä¼˜ç§€çš„å…¨æ–‡æœç´¢èƒ½åŠ›
- é«˜å¯æ‰©å±•æ€§å’Œæ€§èƒ½
- æ´»è·ƒçš„å¼€æºç¤¾åŒº

**Redis - ç¼“å­˜æ•°æ®åº“**
**é€‰æ‹©ç†ç”±**:
- å†…å­˜å­˜å‚¨ï¼Œæé«˜æ€§èƒ½
- ä¸°å¯Œçš„æ•°æ®ç»“æ„
- æŒä¹…åŒ–æ”¯æŒ
- é›†ç¾¤å’Œé«˜å¯ç”¨
- ä¸Node.jsç”Ÿæ€é›†æˆè‰¯å¥½

#### 3.3.2 æ•°æ®åˆ†ç‰‡ç­–ç•¥

**æ°´å¹³åˆ†ç‰‡**
```sql
-- ç”¨æˆ·è¡¨æŒ‰ç”¨æˆ·IDåˆ†ç‰‡
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) PARTITION BY HASH (id);

-- åˆ›å»ºåˆ†ç‰‡
CREATE TABLE users_0 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 0);
CREATE TABLE users_1 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 1);
CREATE TABLE users_2 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 2);
CREATE TABLE users_3 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 3);
```

**è¯»å†™åˆ†ç¦»**
```typescript
// æ•°æ®åº“è¿æ¥é…ç½®
const dbConfig = {
  master: {
    host: 'master-db.internal',
    port: 5432,
    database: 'nexus_ai',
    user: 'app_user',
    password: process.env.DB_PASSWORD
  },
  replica: {
    host: 'replica-db.internal',
    port: 5432,
    database: 'nexus_ai',
    user: 'readonly_user',
    password: process.env.DB_PASSWORD
  }
};

// è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶
const readWriteMiddleware = (req, res, next) => {
  if (req.method === 'GET' || req.method === 'HEAD') {
    req.db = replicaPool; // è¯»æ“ä½œä½¿ç”¨ä»åº“
  } else {
    req.db = masterPool;   // å†™æ“ä½œä½¿ç”¨ä¸»åº“
  }
  next();
};
```

---

## 4. AIæœåŠ¡é›†æˆæ¶æ„

### 4.1 AIæœåŠ¡æŠ½è±¡å±‚

#### 4.1.1 ç»Ÿä¸€AIæ¥å£

```typescript
// AIæœåŠ¡ç»Ÿä¸€æ¥å£
interface AIService {
  name: string;
  version: string;
  capabilities: AICapability[];
  
  // èŠå¤©å¯¹è¯
  chat(request: ChatRequest): Promise<ChatResponse>;
  
  // ä»£ç åˆ†æ
  analyzeCode(request: CodeAnalysisRequest): Promise<CodeAnalysisResponse>;
  
  // æ–‡æœ¬ç”Ÿæˆ
  generateText(request: TextGenerationRequest): Promise<TextGenerationResponse>;
  
  // å¥åº·æ£€æŸ¥
  healthCheck(): Promise<boolean>;
}

// èƒ½åŠ›å®šä¹‰
interface AICapability {
  type: 'chat' | 'code-analysis' | 'text-generation' | 'image-generation';
  maxTokens: number;
  supportedLanguages: string[];
  pricing?: PricingInfo;
}
```

#### 4.1.2 æœåŠ¡å®ç°

**GeminiæœåŠ¡å®ç°**
```typescript
export class GeminiService implements AIService {
  name = 'Google Gemini';
  version = 'Flash 2.5';
  
  capabilities: AICapability[] = [
    {
      type: 'chat',
      maxTokens: 8192,
      supportedLanguages: ['en', 'zh', 'ja', 'ko', 'es', 'fr']
    },
    {
      type: 'code-analysis',
      maxTokens: 4096,
      supportedLanguages: ['javascript', 'typescript', 'python', 'java', 'go']
    }
  ];
  
  async chat(request: ChatRequest): Promise<ChatResponse> {
    const model = this.genAI.getGenerativeModel({ 
      model: "gemini-2.0-flash-exp" 
    });
    
    const result = await model.generateContent(request.message);
    const response = await result.response;
    
    return {
      content: response.text(),
      usage: {
        promptTokens: request.message.length,
        completionTokens: response.text().length,
        totalTokens: request.message.length + response.text().length
      }
    };
  }
  
  async analyzeCode(request: CodeAnalysisRequest): Promise<CodeAnalysisResponse> {
    const prompt = this.buildCodeAnalysisPrompt(request.code, request.language);
    const result = await this.chat({ message: prompt });
    
    return this.parseAnalysisResult(result.content);
  }
}
```

**OpenAIæœåŠ¡å®ç°**
```typescript
export class OpenAIService implements AIService {
  name = 'OpenAI GPT';
  version = 'GPT-4 Turbo';
  
  capabilities: AICapability[] = [
    {
      type: 'chat',
      maxTokens: 4096,
      supportedLanguages: ['en', 'zh', 'ja', 'ko', 'es', 'fr', 'de']
    }
  ];
  
  async chat(request: ChatRequest): Promise<ChatResponse> {
    const response = await this.openai.chat.completions.create({
      model: "gpt-4-turbo-preview",
      messages: [{ role: "user", content: request.message }],
      max_tokens: request.maxTokens || 1000
    });
    
    return {
      content: response.choices[0]?.message?.content || '',
      usage: {
        promptTokens: response.usage?.prompt_tokens || 0,
        completionTokens: response.usage?.completion_tokens || 0,
        totalTokens: response.usage?.total_tokens || 0
      }
    };
  }
}
```

### 4.2 AIæœåŠ¡è·¯ç”±å™¨

```typescript
export class AIRouter {
  private services: Map<string, AIService> = new Map();
  private fallbackChain: string[] = ['gemini', 'openai', 'local'];
  
  constructor() {
    this.registerService('gemini', new GeminiService());
    this.registerService('openai', new OpenAIService());
    this.registerService('local', new LocalModelService());
  }
  
  registerService(name: string, service: AIService) {
    this.services.set(name, service);
  }
  
  async routeRequest<T>(
    requestType: string,
    request: any,
    preferredService?: string
  ): Promise<T> {
    const servicesToTry = preferredService 
      ? [preferredService, ...this.fallbackChain.filter(s => s !== preferredService)]
      : this.fallbackChain;
    
    for (const serviceName of servicesToTry) {
      const service = this.services.get(serviceName);
      if (!service || !service.capabilities.some(c => c.type === requestType)) {
        continue;
      }
      
      try {
        const result = await this.executeRequest(service, requestType, request);
        return result;
      } catch (error) {
        console.warn(`Service ${serviceName} failed:`, error);
        continue;
      }
    }
    
    throw new Error(`All AI services failed for request type: ${requestType}`);
  }
  
  private async executeRequest(
    service: AIService, 
    requestType: string, 
    request: any
  ): Promise<any> {
    switch (requestType) {
      case 'chat':
        return service.chat(request);
      case 'code-analysis':
        return service.analyzeCode(request);
      case 'text-generation':
        return service.generateText(request);
      default:
        throw new Error(`Unsupported request type: ${requestType}`);
    }
  }
}
```

### 4.3 æˆæœ¬ä¼˜åŒ–ç­–ç•¥

#### 4.3.1 æ™ºèƒ½ç¼“å­˜

```typescript
export class AICacheManager {
  private redis: Redis;
  private cacheConfig = {
    ttl: {
      chat: 300,        // 5åˆ†é’Ÿ
      codeAnalysis: 600, // 10åˆ†é’Ÿ
      textGeneration: 900 // 15åˆ†é’Ÿ
    }
  };
  
  async getCachedResponse(
    service: string,
    requestType: string,
    requestHash: string
  ): Promise<any | null> {
    const key = `ai:${service}:${requestType}:${requestHash}`;
    const cached = await this.redis.get(key);
    return cached ? JSON.parse(cached) : null;
  }
  
  async setCachedResponse(
    service: string,
    requestType: string,
    requestHash: string,
    response: any
  ): Promise<void> {
    const key = `ai:${service}:${requestType}:${requestHash}`;
    const ttl = this.cacheConfig.ttl[requestType] || 300;
    await this.redis.setex(key, ttl, JSON.stringify(response));
  }
}
```

#### 4.3.2 è¯·æ±‚æ‰¹å¤„ç†

```typescript
export class BatchProcessor {
  private queue: Array<{
    request: any;
    resolve: (value: any) => void;
    reject: (error: any) => void;
  }> = [];
  
  private processing = false;
  private batchSize = 10;
  private batchTimeout = 1000; // 1ç§’
  
  async addToBatch(request: any): Promise<any> {
    return new Promise((resolve, reject) => {
      this.queue.push({ request, resolve, reject });
      this.processBatch();
    });
  }
  
  private async processBatch() {
    if (this.processing) return;
    
    this.processing = true;
    
    // ç­‰å¾…æ‰¹é‡è¯·æ±‚æˆ–è¶…æ—¶
    await new Promise(resolve => setTimeout(resolve, this.batchTimeout));
    
    const batch = this.queue.splice(0, this.batchSize);
    if (batch.length === 0) {
      this.processing = false;
      return;
    }
    
    try {
      // æ‰¹é‡å¤„ç†è¯·æ±‚
      const responses = await this.processBatchRequests(batch);
      
      // è¿”å›ç»“æœ
      batch.forEach((item, index) => {
        item.resolve(responses[index]);
      });
    } catch (error) {
      batch.forEach(item => item.reject(error));
    }
    
    this.processing = false;
    
    // å¦‚æœè¿˜æœ‰è¯·æ±‚ï¼Œç»§ç»­å¤„ç†
    if (this.queue.length > 0) {
      this.processBatch();
    }
  }
}
```

---

## 5. å®‰å…¨æ¶æ„

### 5.1 è®¤è¯æˆæƒæ¶æ„

#### 5.1.1 JWTä»¤ç‰Œç®¡ç†

```typescript
// JWTé…ç½®
const jwtConfig = {
  accessToken: {
    secret: process.env.JWT_ACCESS_SECRET,
    expiresIn: '15m',
    algorithm: 'HS256'
  },
  refreshToken: {
    secret: process.env.JWT_REFRESH_SECRET,
    expiresIn: '7d',
    algorithm: 'HS256'
  }
};

// ä»¤ç‰Œç”Ÿæˆ
export class TokenService {
  generateAccessToken(payload: UserPayload): string {
    return jwt.sign(payload, jwtConfig.accessToken.secret, {
      expiresIn: jwtConfig.accessToken.expiresIn,
      algorithm: jwtConfig.accessToken.algorithm as jwt.Algorithm
    });
  }
  
  generateRefreshToken(payload: UserPayload): string {
    return jwt.sign(payload, jwtConfig.refreshToken.secret, {
      expiresIn: jwtConfig.refreshToken.expiresIn,
      algorithm: jwtConfig.refreshToken.algorithm as jwt.Algorithm
    });
  }
  
  verifyAccessToken(token: string): UserPayload {
    return jwt.verify(token, jwtConfig.accessToken.secret) as UserPayload;
  }
}
```

#### 5.1.2 æƒé™æ§åˆ¶æ¨¡å‹

```typescript
// RBACæƒé™æ¨¡å‹
interface Permission {
  resource: string;      // èµ„æºç±»å‹ (template, prompt, user)
  action: string;         // æ“ä½œç±»å‹ (create, read, update, delete)
  condition?: string;     // æ¡ä»¶é™åˆ¶ (owner, public, admin)
}

interface Role {
  name: string;
  permissions: Permission[];
}

// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
export const requirePermission = (permission: Permission) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const user = req.user;
      if (!user) {
        return res.status(401).json({ error: 'Unauthorized' });
      }
      
      const hasPermission = await checkUserPermission(user, permission);
      if (!hasPermission) {
        return res.status(403).json({ error: 'Forbidden' });
      }
      
      next();
    } catch (error) {
      res.status(500).json({ error: 'Internal Server Error' });
    }
  };
};

// ä½¿ç”¨ç¤ºä¾‹
app.delete('/api/templates/:id', 
  authenticateToken,
  requirePermission({
    resource: 'template',
    action: 'delete',
    condition: 'owner'
  }),
  deleteTemplate
);
```

### 5.2 æ•°æ®å®‰å…¨

#### 5.2.1 æ•°æ®åŠ å¯†

```typescript
// æ•°æ®åŠ å¯†æœåŠ¡
export class EncryptionService {
  private algorithm = 'aes-256-gcm';
  private key = crypto.scryptSync(process.env.ENCRYPTION_KEY!, 'salt', 32);
  
  encrypt(text: string): { encrypted: string; iv: string; tag: string } {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.key);
    cipher.setAAD(Buffer.from('additional-data'));
    
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const tag = cipher.getAuthTag();
    
    return {
      encrypted,
      iv: iv.toString('hex'),
      tag: tag.toString('hex')
    };
  }
  
  decrypt(encryptedData: { encrypted: string; iv: string; tag: string }): string {
    const decipher = crypto.createDecipher(this.algorithm, this.key);
    decipher.setAAD(Buffer.from('additional-data'));
    decipher.setAuthTag(Buffer.from(encryptedData.tag, 'hex'));
    
    let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}
```

#### 5.2.2 æ•æ„Ÿæ•°æ®å¤„ç†

```typescript
// æ•æ„Ÿæ•°æ®è„±æ•
export class DataMaskingService {
  maskEmail(email: string): string {
    const [username, domain] = email.split('@');
    const maskedUsername = username.slice(0, 2) + '*'.repeat(username.length - 2);
    return `${maskedUsername}@${domain}`;
  }
  
  maskPhone(phone: string): string {
    return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  }
  
  maskApiKey(apiKey: string): string {
    return apiKey.slice(0, 8) + '*'.repeat(apiKey.length - 8);
  }
}

// æ•°æ®åº“å­—æ®µåŠ å¯†
@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;
  
  @Column()
  username: string;
  
  @Column()
  @Transform(({ value }) => {
    // åœ¨è¿”å›ç»™å‰ç«¯æ—¶è¿›è¡Œè„±æ•
    return new DataMaskingService().maskEmail(value);
  })
  email: string;
  
  @Column('text')
  @Transform(({ value }) => {
    // æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
    return new EncryptionService().encrypt(value);
  })
  privateKey: string;
}
```

### 5.3 APIå®‰å…¨

#### 5.3.1 è¯·æ±‚é™æµ

```typescript
// åŸºäºç”¨æˆ·çš„é™æµ
export class RateLimiter {
  private redis: Redis;
  
  constructor(redis: Redis) {
    this.redis = redis;
  }
  
  async checkRateLimit(
    userId: string,
    endpoint: string,
    limit: number,
    windowMs: number
  ): Promise<{ allowed: boolean; remaining: number; resetTime: number }> {
    const key = `rate_limit:${userId}:${endpoint}`;
    const windowMsInSeconds = Math.ceil(windowMs / 1000);
    
    const current = await this.redis.incr(key);
    
    if (current === 1) {
      await this.redis.expire(key, windowMsInSeconds);
    }
    
    const remaining = Math.max(0, limit - current);
    const resetTime = Date.now() + windowMsInSeconds * 1000;
    
    return {
      allowed: current <= limit,
      remaining,
      resetTime
    };
  }
}

// é™æµä¸­é—´ä»¶
export const rateLimitMiddleware = (endpoint: string, limit: number, windowMs: number) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const userId = req.user?.id || req.ip;
    const rateLimiter = new RateLimiter(redis);
    
    const result = await rateLimiter.checkRateLimit(userId, endpoint, limit, windowMs);
    
    res.set({
      'X-RateLimit-Limit': limit,
      'X-RateLimit-Remaining': result.remaining,
      'X-RateLimit-Reset': result.resetTime
    });
    
    if (!result.allowed) {
      return res.status(429).json({ 
        error: 'Too Many Requests',
        retryAfter: Math.ceil((result.resetTime - Date.now()) / 1000)
      });
    }
    
    next();
  };
};
```

#### 5.3.2 è¾“å…¥éªŒè¯

```typescript
// è¯·æ±‚éªŒè¯Schema
export const createTemplateSchema = Joi.object({
  title: Joi.string().min(1).max(100).required(),
  description: Joi.string().min(1).max(500).required(),
  stage: Joi.string().valid(...Object.values(ProcessStage)).required(),
  techStack: Joi.array().items(Joi.string().max(50)).max(10).required(),
  promptContent: Joi.string().min(10).max(10000).required(),
  inputFormat: Joi.string().max(1000).required(),
  outputFormat: Joi.string().max(1000).required()
});

// éªŒè¯ä¸­é—´ä»¶
export const validateRequest = (schema: Joi.ObjectSchema) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const { error } = schema.validate(req.body);
    
    if (error) {
      return res.status(400).json({
        error: 'Validation Error',
        details: error.details.map(detail => ({
          field: detail.path.join('.'),
          message: detail.message
        }))
      });
    }
    
    next();
  };
};

// ä½¿ç”¨ç¤ºä¾‹
app.post('/api/templates',
  authenticateToken,
  validateRequest(createTemplateSchema),
  createTemplate
);
```

---

## 6. æ€§èƒ½ä¼˜åŒ–æ¶æ„

### 6.1 ç¼“å­˜ç­–ç•¥

#### 6.1.1 å¤šçº§ç¼“å­˜æ¶æ„

```typescript
// ç¼“å­˜å±‚çº§
export enum CacheLevel {
  MEMORY = 'memory',      // å†…å­˜ç¼“å­˜ - æœ€å¿«
  REDIS = 'redis',        // Redisç¼“å­˜ - å¿«
  DATABASE = 'database'   // æ•°æ®åº“ - æ…¢
}

export class CacheManager {
  private memoryCache: Map<string, { data: any; expiry: number }> = new Map();
  private redis: Redis;
  
  async get<T>(key: string, fallback: () => Promise<T>): Promise<T> {
    // 1. æ£€æŸ¥å†…å­˜ç¼“å­˜
    const memoryData = this.getFromMemory<T>(key);
    if (memoryData) return memoryData;
    
    // 2. æ£€æŸ¥Redisç¼“å­˜
    const redisData = await this.getFromRedis<T>(key);
    if (redisData) {
      // å›å†™åˆ°å†…å­˜ç¼“å­˜
      this.setToMemory(key, redisData, 60); // 1åˆ†é’Ÿ
      return redisData;
    }
    
    // 3. ä»æ•°æ®åº“è·å–
    const dbData = await fallback();
    
    // 4. å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚
    await this.setToRedis(key, dbData, 3600); // 1å°æ—¶
    this.setToMemory(key, dbData, 60); // 1åˆ†é’Ÿ
    
    return dbData;
  }
  
  private getFromMemory<T>(key: string): T | null {
    const item = this.memoryCache.get(key);
    if (!item) return null;
    
    if (Date.now() > item.expiry) {
      this.memoryCache.delete(key);
      return null;
    }
    
    return item.data;
  }
  
  private async getFromRedis<T>(key: string): Promise<T | null> {
    const data = await this.redis.get(key);
    return data ? JSON.parse(data) : null;
  }
  
  private async setToRedis(key: string, data: any, ttlSeconds: number): Promise<void> {
    await this.redis.setex(key, ttlSeconds, JSON.stringify(data));
  }
  
  private setToMemory(key: string, data: any, ttlSeconds: number): void {
    this.memoryCache.set(key, {
      data,
      expiry: Date.now() + ttlSeconds * 1000
    });
  }
}
```

#### 6.1.2 æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ

```typescript
export class CacheInvalidationService {
  private redis: Redis;
  private eventBus: EventBus;
  
  constructor(redis: Redis, eventBus: EventBus) {
    this.redis = redis;
    this.eventBus = eventBus;
    
    // ç›‘å¬ä¸šåŠ¡äº‹ä»¶ï¼Œè‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜
    this.setupInvalidationListeners();
  }
  
  private setupInvalidationListeners() {
    // æ¨¡æ¿æ›´æ–°æ—¶å¤±æ•ˆç›¸å…³ç¼“å­˜
    this.eventBus.on('template.updated', async (event) => {
      await this.invalidateTemplateCache(event.templateId);
    });
    
    // ç”¨æˆ·æ›´æ–°æ—¶å¤±æ•ˆç”¨æˆ·ç›¸å…³ç¼“å­˜
    this.eventBus.on('user.updated', async (event) => {
      await this.invalidateUserCache(event.userId);
    });
  }
  
  async invalidateTemplateCache(templateId: string) {
    const patterns = [
      `template:${templateId}`,
      `template:list:*`,
      `user:*:favorites`,
      `search:template:*`
    ];
    
    for (const pattern of patterns) {
      const keys = await this.redis.keys(pattern);
      if (keys.length > 0) {
        await this.redis.del(...keys);
      }
    }
  }
}
```

### 6.2 æ•°æ®åº“ä¼˜åŒ–

#### 6.2.1 æŸ¥è¯¢ä¼˜åŒ–

```typescript
// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
export class OptimizedQueryBuilder {
  static async getTemplatesPaginated(
    filters: TemplateFilters,
    pagination: { page: number; pageSize: number }
  ): Promise<PaginatedResult<Template>> {
    // ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£OFFSET
    const offset = (pagination.page - 1) * pagination.pageSize;
    
    // é¢„åŠ è½½å…³è”æ•°æ®ï¼Œé¿å…N+1æŸ¥è¯¢
    const templates = await prisma.template.findMany({
      where: this.buildWhereClause(filters),
      include: {
        author: {
          select: { id: true, username: true, avatar: true }
        },
        _count: {
          select: {
            likes: true,
            comments: true,
            usage: true
          }
        }
      },
      orderBy: [
        { isPinned: 'desc' },
        { createdAt: 'desc' }
      ],
      skip: offset,
      take: pagination.pageSize
    });
    
    // è·å–æ€»æ•°ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨COUNT OVERï¼‰
    const total = await prisma.template.count({
      where: this.buildWhereClause(filters)
    });
    
    return {
      data: templates,
      pagination: {
        page: pagination.page,
        pageSize: pagination.pageSize,
        total,
        totalPages: Math.ceil(total / pagination.pageSize)
      }
    };
  }
  
  private static buildWhereClause(filters: TemplateFilters) {
    const where: any = {};
    
    if (filters.stage) {
      where.stage = filters.stage;
    }
    
    if (filters.techStack?.length) {
      where.techStack = {
        hasSome: filters.techStack
      };
    }
    
    if (filters.search) {
      where.OR = [
        { title: { contains: filters.search, mode: 'insensitive' } },
        { description: { contains: filters.search, mode: 'insensitive' } }
      ];
    }
    
    return where;
  }
}
```

#### 6.2.2 è¿æ¥æ± ä¼˜åŒ–

```typescript
// æ•°æ®åº“è¿æ¥æ± é…ç½®
const dbConfig = {
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  
  // è¿æ¥æ± é…ç½®
  max: 20,              // æœ€å¤§è¿æ¥æ•°
  min: 5,               // æœ€å°è¿æ¥æ•°
  acquire: 30000,       // è·å–è¿æ¥è¶…æ—¶æ—¶é—´(ms)
  idle: 10000,          // è¿æ¥ç©ºé—²è¶…æ—¶æ—¶é—´(ms)
  
  // è¿æ¥å¥åº·æ£€æŸ¥
  healthCheckInterval: 30000,
  healthCheckGracePeriod: 5000,
  
  // æŸ¥è¯¢è¶…æ—¶
  statement_timeout: 30000,
  query_timeout: 30000
};

// Prismaé…ç½®
export const prisma = new PrismaClient({
  datasources: {
    db: {
      url: `postgresql://${dbConfig.user}:${dbConfig.password}@${dbConfig.host}:${dbConfig.port}/${dbConfig.database}?connection_limit=${dbConfig.max}&pool_timeout=${dbConfig.acquire / 1000}`
    }
  },
  log: ['query', 'info', 'warn', 'error'],
  errorFormat: 'pretty'
});
```

### 6.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### 6.3.1 ç»„ä»¶æ‡’åŠ è½½

```typescript
// è·¯ç”±çº§åˆ«çš„æ‡’åŠ è½½
const ProcessNavigator = lazy(() => import('../pages/ProcessNavigator'));
const Library = lazy(() => import('../pages/Library'));
const Playground = lazy(() => import('../pages/Playground'));

// ç»„ä»¶çº§åˆ«çš„æ‡’åŠ è½½
const TemplateCard = lazy(() => import('../components/TemplateCard'));

// ä½¿ç”¨SuspenseåŒ…è£…
const TemplateList = ({ templates }: { templates: Template[] }) => {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {templates.map((template) => (
        <Suspense 
          key={template.id} 
          fallback={<TemplateCardSkeleton />}
        >
          <TemplateCard template={template} />
        </Suspense>
      ))}
    </div>
  );
};
```

#### 6.3.2 è™šæ‹Ÿæ»šåŠ¨

```typescript
// å¤§åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨å®ç°
export const VirtualList = <T,>({
  items,
  itemHeight,
  containerHeight,
  renderItem
}: VirtualListProps<T>) => {
  const [scrollTop, setScrollTop] = useState(0);
  
  const visibleItems = useMemo(() => {
    const startIndex = Math.floor(scrollTop / itemHeight);
    const endIndex = Math.min(
      startIndex + Math.ceil(containerHeight / itemHeight) + 1,
      items.length
    );
    
    return items.slice(startIndex, endIndex).map((item, index) => ({
      item,
      index: startIndex + index
    }));
  }, [items, itemHeight, containerHeight, scrollTop]);
  
  return (
    <div
      style={{ height: containerHeight, overflow: 'auto' }}
      onScroll={(e) => setScrollTop(e.currentTarget.scrollTop)}
    >
      <div style={{ height: items.length * itemHeight, position: 'relative' }}>
        {visibleItems.map(({ item, index }) => (
          <div
            key={index}
            style={{
              position: 'absolute',
              top: index * itemHeight,
              height: itemHeight,
              width: '100%'
            }}
          >
            {renderItem(item, index)}
          </div>
        ))}
      </div>
    </div>
  );
};
```

---

## 7. ç›‘æ§ä¸è¿ç»´

### 7.1 ç›‘æ§ä½“ç³»

#### 7.1.1 åº”ç”¨ç›‘æ§

```typescript
// è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†
export class MetricsCollector {
  private prometheus: Registry;
  
  constructor() {
    this.prometheus = new Registry();
    this.setupMetrics();
  }
  
  private setupMetrics() {
    // HTTPè¯·æ±‚è®¡æ•°å™¨
    new Counter({
      name: 'http_requests_total',
      help: 'Total number of HTTP requests',
      labelNames: ['method', 'route', 'status'],
      registers: [this.prometheus]
    });
    
    // è¯·æ±‚å»¶è¿Ÿç›´æ–¹å›¾
    new Histogram({
      name: 'http_request_duration_seconds',
      help: 'HTTP request duration in seconds',
      labelNames: ['method', 'route'],
      buckets: [0.1, 0.5, 1, 2, 5],
      registers: [this.prometheus]
    });
    
    // AIæœåŠ¡è°ƒç”¨è®¡æ•°å™¨
    new Counter({
      name: 'ai_service_calls_total',
      help: 'Total number of AI service calls',
      labelNames: ['service', 'method', 'status'],
      registers: [this.prometheus]
    });
  }
  
  // ç›‘æ§ä¸­é—´ä»¶
  monitoringMiddleware() {
    return (req: Request, res: Response, next: NextFunction) => {
      const start = Date.now();
      
      res.on('finish', () => {
        const duration = (Date.now() - start) / 1000;
        
        // è®°å½•HTTPæŒ‡æ ‡
        this.httpRequestsTotal
          .labels(req.method, req.route?.path || req.path, res.statusCode.toString())
          .inc();
          
        this.httpRequestDuration
          .labels(req.method, req.route?.path || req.path)
          .observe(duration);
      });
      
      next();
    };
  }
}
```

#### 7.1.2 æ—¥å¿—ç®¡ç†

```typescript
// ç»“æ„åŒ–æ—¥å¿—
export class Logger {
  private winston: Winston.Logger;
  
  constructor() {
    this.winston = winston.createLogger({
      level: process.env.LOG_LEVEL || 'info',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json()
      ),
      defaultMeta: {
        service: 'nexus-ai-api',
        version: process.env.APP_VERSION
      },
      transports: [
        new winston.transports.Console({
          format: winston.format.combine(
            winston.format.colorize(),
            winston.format.simple()
          )
        }),
        new winston.transports.File({
          filename: 'logs/error.log',
          level: 'error'
        }),
        new winston.transports.File({
          filename: 'logs/combined.log'
        })
      ]
    });
  }
  
  info(message: string, meta?: any) {
    this.winston.info(message, meta);
  }
  
  error(message: string, error?: Error, meta?: any) {
    this.winston.error(message, { 
      error: error?.stack, 
      ...meta 
    });
  }
  
  // è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
  requestLogger() {
    return (req: Request, res: Response, next: NextFunction) => {
      const start = Date.now();
      
      res.on('finish', () => {
        const duration = Date.now() - start;
        
        this.info('HTTP Request', {
          method: req.method,
          url: req.url,
          status: res.statusCode,
          duration,
          userAgent: req.get('User-Agent'),
          ip: req.ip,
          userId: req.user?.id
        });
      });
      
      next();
    };
  }
}
```

### 7.2 å¥åº·æ£€æŸ¥

```typescript
// å¥åº·æ£€æŸ¥æœåŠ¡
export class HealthCheckService {
  private checks: Map<string, HealthCheck> = new Map();
  
  constructor() {
    this.setupDefaultChecks();
  }
  
  private setupDefaultChecks() {
    // æ•°æ®åº“å¥åº·æ£€æŸ¥
    this.addCheck('database', async () => {
      try {
        await prisma.$queryRaw`SELECT 1`;
        return { status: 'healthy', message: 'Database connection OK' };
      } catch (error) {
        return { status: 'unhealthy', message: 'Database connection failed' };
      }
    });
    
    // Rediså¥åº·æ£€æŸ¥
    this.addCheck('redis', async () => {
      try {
        await redis.ping();
        return { status: 'healthy', message: 'Redis connection OK' };
      } catch (error) {
        return { status: 'unhealthy', message: 'Redis connection failed' };
      }
    });
    
    // AIæœåŠ¡å¥åº·æ£€æŸ¥
    this.addCheck('ai_service', async () => {
      try {
        const airouter = new AIRouter();
        await airouter.healthCheck();
        return { status: 'healthy', message: 'AI services OK' };
      } catch (error) {
        return { status: 'unhealthy', message: 'AI services unavailable' };
      }
    });
  }
  
  addCheck(name: string, check: HealthCheck) {
    this.checks.set(name, check);
  }
  
  async checkHealth(): Promise<HealthStatus> {
    const results: Record<string, HealthResult> = {};
    let overallStatus: 'healthy' | 'unhealthy' = 'healthy';
    
    for (const [name, check] of this.checks) {
      try {
        const result = await check();
        results[name] = result;
        
        if (result.status === 'unhealthy') {
          overallStatus = 'unhealthy';
        }
      } catch (error) {
        results[name] = {
          status: 'unhealthy',
          message: error.message
        };
        overallStatus = 'unhealthy';
      }
    }
    
    return {
      status: overallStatus,
      timestamp: new Date().toISOString(),
      checks: results
    };
  }
}

// å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.get('/health', async (req, res) => {
  const healthService = new HealthCheckService();
  const status = await healthService.checkHealth();
  
  const statusCode = status.status === 'healthy' ? 200 : 503;
  res.status(statusCode).json(status);
});
```

---

## 8. éƒ¨ç½²æ¶æ„

### 8.1 å®¹å™¨åŒ–éƒ¨ç½²

#### 8.1.1 Dockeré…ç½®

```dockerfile
# å‰ç«¯Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

```dockerfile
# åç«¯Dockerfile
FROM node:20-alpine

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºç 
COPY . .
RUN npm run build

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

USER nodejs

EXPOSE 3000
CMD ["npm", "start"]
```

#### 8.1.2 Docker Composeé…ç½®

```yaml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - api-gateway
    networks:
      - nexus-network

  # APIç½‘å…³
  api-gateway:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - user-service
      - template-service
      - prompt-service
    networks:
      - nexus-network

  # ç”¨æˆ·æœåŠ¡
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://nexus:nexus@postgres:5432/nexus_users
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    networks:
      - nexus-network
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # æ¨¡æ¿æœåŠ¡
  template-service:
    build:
      context: ./services/template-service
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://nexus:nexus@postgres:5432/nexus_templates
      - REDIS_URL=redis://redis:6379
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    depends_on:
      - postgres
      - redis
      - elasticsearch
    networks:
      - nexus-network

  # æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=nexus
      - POSTGRES_USER=nexus
      - POSTGRES_PASSWORD=nexus
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - nexus-network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - nexus-network

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - nexus-network

volumes:
  postgres_data:
  redis_data:
  elasticsearch_data:

networks:
  nexus-network:
    driver: bridge
```

### 8.2 Kuberneteséƒ¨ç½²

#### 8.2.1 éƒ¨ç½²é…ç½®

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: nexus-ai

---
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexus-config
  namespace: nexus-ai
data:
  NODE_ENV: "production"
  LOG_LEVEL: "info"
  REDIS_URL: "redis://redis-service:6379"

---
# user-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
  namespace: nexus-ai
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: nexus-ai/user-service:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: nexus-secrets
              key: database-url
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: nexus-secrets
              key: jwt-secret
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5

---
# user-service-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: user-service
  namespace: nexus-ai
spec:
  selector:
    app: user-service
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: ClusterIP
```

#### 8.2.2 HPAè‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: user-service-hpa
  namespace: nexus-ai
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
```

---

## 9. æ¶æ„æ¼”è¿›è§„åˆ’

### 9.1 çŸ­æœŸæ¼”è¿› (3-6ä¸ªæœˆ)

#### 9.1.1 æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**: å®æ–½æ›´æ™ºèƒ½çš„ç¼“å­˜ç­–ç•¥ï¼Œæå‡å“åº”é€Ÿåº¦
- **æ•°æ®åº“ä¼˜åŒ–**: å®æ–½æ•°æ®åº“åˆ†ç‰‡ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- **CDNé›†æˆ**: é›†æˆCDNæœåŠ¡ï¼ŒåŠ é€Ÿé™æ€èµ„æºåŠ è½½

#### 9.1.2 åŠŸèƒ½å¢å¼º
- **å®æ—¶é€šä¿¡**: å®æ–½WebSocketæ”¯æŒå®æ—¶åä½œ
- **æœç´¢ä¼˜åŒ–**: é›†æˆElasticsearchæå‡æœç´¢ä½“éªŒ
- **ç›‘æ§å®Œå–„**: å®Œå–„ç›‘æ§å‘Šè­¦ä½“ç³»

### 9.2 ä¸­æœŸæ¼”è¿› (6-12ä¸ªæœˆ)

#### 9.2.1 æ¶æ„å‡çº§
- **æœåŠ¡ç½‘æ ¼**: å¼•å…¥Istioå®ç°æœåŠ¡æ²»ç†
- **äº‹ä»¶é©±åŠ¨**: å®æ–½äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæå‡ç³»ç»Ÿè§£è€¦
- **å¤šåŒºåŸŸéƒ¨ç½²**: å®æ–½å¤šåŒºåŸŸéƒ¨ç½²ï¼Œæå‡å¯ç”¨æ€§

#### 9.2.2 æŠ€æœ¯åˆ›æ–°
- **AIæ¨¡å‹ä¼˜åŒ–**: é›†æˆæ›´å¤šAIæ¨¡å‹ï¼Œæå‡æœåŠ¡è´¨é‡
- **è¾¹ç¼˜è®¡ç®—**: æ¢ç´¢è¾¹ç¼˜è®¡ç®—ï¼Œé™ä½å»¶è¿Ÿ
- **åŒºå—é“¾é›†æˆ**: æ¢ç´¢åŒºå—é“¾æŠ€æœ¯ï¼Œç¡®ä¿æ•°æ®å¯ä¿¡

### 9.3 é•¿æœŸè§„åˆ’ (1-2å¹´)

#### 9.3.1 å¹³å°åŒ–
- **å¼€æ”¾å¹³å°**: æ„å»ºå¼€æ”¾APIå¹³å°ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹é›†æˆ
- **æ’ä»¶ç”Ÿæ€**: æ„å»ºæ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œæ”¯æŒåŠŸèƒ½æ‰©å±•
- **ä½ä»£ç å¹³å°**: å‘å±•ä½ä»£ç å¹³å°ï¼Œé™ä½ä½¿ç”¨é—¨æ§›

#### 9.3.2 æ™ºèƒ½åŒ–
- **AIè‡ªåŠ¨åŒ–**: å®æ–½æ›´å¤šAIè‡ªåŠ¨åŒ–åŠŸèƒ½
- **é¢„æµ‹åˆ†æ**: é›†æˆé¢„æµ‹åˆ†æï¼Œè¾…åŠ©å†³ç­–
- **ä¸ªæ€§åŒ–æœåŠ¡**: æä¾›æ›´ä¸ªæ€§åŒ–çš„æ™ºèƒ½æœåŠ¡

---

## 10. æŠ€æœ¯é£é™©ä¸åº”å¯¹

### 10.1 æŠ€æœ¯å€ºåŠ¡ç®¡ç†

| é£é™©ç±»å‹ | é£é™©æè¿° | å½±å“ç­‰çº§ | åº”å¯¹ç­–ç•¥ |
|----------|----------|----------|----------|
| **ä»£ç è´¨é‡** | å¿«é€Ÿå¼€å‘å¯¼è‡´ä»£ç è´¨é‡ä¸‹é™ | ä¸­ | ä»£ç å®¡æŸ¥ã€é‡æ„è®¡åˆ’ |
| **æŠ€æœ¯æ ˆæ›´æ–°** | ä¾èµ–åº“ç‰ˆæœ¬æ»å | ä¸­ | å®šæœŸæ›´æ–°ã€å®‰å…¨è¡¥ä¸ |
| **æ¶æ„è…åŒ–** | æ¶æ„è®¾è®¡ä¸å®é™…å®ç°è„±èŠ‚ | é«˜ | æ¶æ„è¯„å®¡ã€æ–‡æ¡£æ›´æ–° |
| **æµ‹è¯•è¦†ç›–** | æµ‹è¯•ä¸è¶³å¯¼è‡´è´¨é‡é—®é¢˜ | é«˜ | æå‡æµ‹è¯•è¦†ç›–ç‡ã€è‡ªåŠ¨åŒ–æµ‹è¯• |

### 10.2 æŠ€æœ¯é€‰å‹é£é™©

| æŠ€æœ¯ç»„ä»¶ | é£é™©æè¿° | åº”å¯¹æªæ–½ |
|----------|----------|----------|
| **Node.js** | å•çº¿ç¨‹é˜»å¡é—®é¢˜ | ä½¿ç”¨Worker Threadsã€é›†ç¾¤æ¨¡å¼ |
| **PostgreSQL** | å¤§æ•°æ®é‡æ€§èƒ½é—®é¢˜ | åˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦» |
| **Redis** | å†…å­˜æˆæœ¬é«˜ | æ•°æ®åˆ†å±‚å­˜å‚¨ã€æ·˜æ±°ç­–ç•¥ |
| **AIæœåŠ¡** | ç¬¬ä¸‰æ–¹ä¾èµ–é£é™© | å¤šä¾›åº”å•†ã€æœ¬åœ°å¤‡ä»½ |

### 10.3 è¿ç»´é£é™©

| é£é™©ç±»å‹ | é£é™©æè¿° | é¢„é˜²æªæ–½ |
|----------|----------|----------|
| **æœåŠ¡æ•…éšœ** | å•ç‚¹æœåŠ¡ä¸å¯ç”¨ | é«˜å¯ç”¨éƒ¨ç½²ã€æ•…éšœè½¬ç§» |
| **æ•°æ®ä¸¢å¤±** | æ•°æ®å¤‡ä»½ä¸è¶³ | å¤šåœ°åŸŸå¤‡ä»½ã€å®šæœŸæ¢å¤æµ‹è¯• |
| **å®‰å…¨æ¼æ´** | ç³»ç»Ÿè¢«æ”»å‡» | å®‰å…¨æ‰«æã€åŠæ—¶æ‰“è¡¥ä¸ |
| **å®¹é‡ä¸è¶³** | æµé‡æ¿€å¢å¯¼è‡´ç³»ç»Ÿå´©æºƒ | è‡ªåŠ¨æ‰©ç¼©å®¹ã€å®¹é‡è§„åˆ’ |

---

## 11. æ€»ç»“

### 11.1 æ¶æ„ä¼˜åŠ¿
1. **å¾®æœåŠ¡æ¶æ„**: æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ã€æ˜“äºæ‰©å±•
2. **æŠ€æœ¯æ ˆç°ä»£**: ä½¿ç”¨æˆç†Ÿç¨³å®šçš„æŠ€æœ¯æ ˆ
3. **å®‰å…¨å¯é **: å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œæ•°æ®åŠ å¯†
4. **é«˜æ€§èƒ½**: å¤šçº§ç¼“å­˜ï¼Œæ•°æ®åº“ä¼˜åŒ–
5. **å¯è§‚æµ‹**: å®Œæ•´çš„ç›‘æ§æ—¥å¿—ä½“ç³»

### 11.2 å…³é”®å†³ç­–
1. **å‰åç«¯åˆ†ç¦»**: æå‡å¼€å‘æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒ
2. **å¾®æœåŠ¡æ¶æ„**: æ”¯æŒä¸šåŠ¡å¿«é€Ÿè¿­ä»£å’Œæ‰©å±•
3. **å®¹å™¨åŒ–éƒ¨ç½²**: ç®€åŒ–éƒ¨ç½²å’Œè¿ç»´
4. **å¤šäº‘ç­–ç•¥**: é™ä½ä¾›åº”å•†é”å®šé£é™©

### 11.3 æˆåŠŸè¦ç´ 
1. **å›¢é˜ŸæŠ€èƒ½åŒ¹é…**: ç¡®ä¿å›¢é˜Ÿå…·å¤‡ç›¸å…³æŠ€æœ¯èƒ½åŠ›
2. **æ¸è¿›å¼æ¼”è¿›**: é¿å…å¤§è§„æ¨¡é‡æ„ï¼Œæ¸è¿›å¼æ”¹è¿›
3. **æŒç»­ç›‘æ§**: å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»
4. **æ–‡æ¡£å®Œå–„**: ä¿æŒæ¶æ„æ–‡æ¡£åŠæ—¶æ›´æ–°

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2024å¹´12æœˆ2æ—¥*  
*ä¸‹æ¬¡è¯„å®¡: 2024å¹´12æœˆ16æ—¥*  
*çŠ¶æ€: å·²å®¡æ ¸*  
*è´Ÿè´£äºº: æŠ€æœ¯å›¢é˜Ÿ*