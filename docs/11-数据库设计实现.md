# æ•°æ®åº“è®¾è®¡å®ç°æ–¹æ¡ˆ

## ğŸ“‹ æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

æœ¬æ–‡æ¡£ä¸ºNexus AIå¹³å°æä¾›å®Œæ•´çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è¡¨ç»“æ„è®¾è®¡ã€ç´¢å¼•ç­–ç•¥ã€æ•°æ®è¿ç§»è„šæœ¬å’Œæ€§èƒ½ä¼˜åŒ–å»ºè®®ã€‚

---

## ğŸ—ï¸ æ•°æ®åº“æ¶æ„é€‰å‹

### æŠ€æœ¯æ ˆé€‰æ‹©

```sql
-- ä¸»æ•°æ®åº“: PostgreSQL 15+
-- åŸå› : 
-- 1. æ”¯æŒJSONå­—æ®µï¼Œé€‚åˆå­˜å‚¨AIå“åº”æ•°æ®
-- 2. å¼ºä¸€è‡´æ€§ï¼Œé€‚åˆç”¨æˆ·æ•°æ®å’Œè®¡è´¹ç³»ç»Ÿ
-- 3. ä¸°å¯Œçš„ç´¢å¼•ç±»å‹ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
-- 4. ä¼˜ç§€çš„æ‰©å±•æ€§å’Œæ€§èƒ½

-- ç¼“å­˜æ•°æ®åº“: Redis 7+
-- åŸå› :
-- 1. ä¼šè¯å­˜å‚¨å’Œå®æ—¶æ•°æ®ç¼“å­˜
-- 2. åˆ†å¸ƒå¼é”å’Œä»»åŠ¡é˜Ÿåˆ—
-- 3. é«˜æ€§èƒ½è¯»å†™èƒ½åŠ›

-- æœç´¢å¼•æ“: Elasticsearch 8+
-- åŸå› :
-- 1. å…¨æ–‡æœç´¢åŠŸèƒ½
-- 2. æ¨¡æ¿å’Œæç¤ºè¯çš„æ™ºèƒ½æ¨è
-- 3. ç”¨æˆ·è¡Œä¸ºåˆ†æ
```

---

## ğŸ“Š æ•°æ®åº“è¡¨è®¾è®¡

### 1. ç”¨æˆ·ç®¡ç†æ¨¡å—

#### 1.1 ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    avatar_url TEXT,
    role user_role DEFAULT 'user',
    status user_status DEFAULT 'active',
    email_verified BOOLEAN DEFAULT FALSE,
    email_verification_token VARCHAR(255),
    password_reset_token VARCHAR(255),
    password_reset_expires_at TIMESTAMPTZ,
    last_login_at TIMESTAMPTZ,
    login_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æšä¸¾ç±»å‹å®šä¹‰
CREATE TYPE user_role AS ENUM ('super_admin', 'admin', 'moderator', 'user', 'guest');
CREATE TYPE user_status AS ENUM ('active', 'inactive', 'suspended', 'deleted');

-- ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### 1.2 ç”¨æˆ·åå¥½è®¾ç½®è¡¨ (user_preferences)

```sql
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    language VARCHAR(10) DEFAULT 'zh',
    theme VARCHAR(20) DEFAULT 'dark',
    timezone VARCHAR(50) DEFAULT 'UTC',
    notifications JSONB DEFAULT '{}',
    ui_settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_user_preferences_user_id ON user_preferences(user_id);
```

#### 1.3 ç”¨æˆ·è®¢é˜…è¡¨ (user_subscriptions)

```sql
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_id VARCHAR(50) NOT NULL,
    status subscription_status DEFAULT 'active',
    current_period_start TIMESTAMPTZ NOT NULL,
    current_period_end TIMESTAMPTZ NOT NULL,
    cancel_at_period_end BOOLEAN DEFAULT FALSE,
    payment_method_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    usage_limits JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE subscription_status AS ENUM ('active', 'canceled', 'past_due', 'unpaid', 'trialing');
CREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_status ON user_subscriptions(status);
CREATE INDEX idx_user_subscriptions_plan_id ON user_subscriptions(plan_id);
```

---

### 2. å†…å®¹ç®¡ç†æ¨¡å—

#### 2.1 æ¨¡æ¿è¡¨ (templates)

```sql
CREATE TABLE templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    content TEXT NOT NULL,
    prompt_content TEXT,
    input_format TEXT,
    output_format TEXT,
    stage template_stage NOT NULL,
    tech_stack TEXT[],
    supports TEXT[],
    app_type VARCHAR(50),
    difficulty template_difficulty DEFAULT 'beginner',
    author_id UUID REFERENCES users(id),
    is_system BOOLEAN DEFAULT FALSE,
    is_featured BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT TRUE,
    status template_status DEFAULT 'draft',
    tags TEXT[],
    metadata JSONB DEFAULT '{}',
    likes_count INTEGER DEFAULT 0,
    usage_count INTEGER DEFAULT 0,
    views_count INTEGER DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0.00,
    rating_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æšä¸¾ç±»å‹
CREATE TYPE template_stage AS ENUM ('requirements', 'product_planning', 'architecture', 'story_creation', 'development', 'qa');
CREATE TYPE template_difficulty AS ENUM ('beginner', 'intermediate', 'advanced');
CREATE TYPE template_status AS ENUM ('draft', 'pending_review', 'approved', 'rejected', 'archived');

-- ç´¢å¼•
CREATE INDEX idx_templates_author_id ON templates(author_id);
CREATE INDEX idx_templates_stage ON templates(stage);
CREATE INDEX idx_templates_difficulty ON templates(difficulty);
CREATE INDEX idx_templates_status ON templates(status);
CREATE INDEX idx_templates_is_public ON templates(is_public);
CREATE INDEX idx_templates_is_featured ON templates(is_featured);
CREATE INDEX idx_templates_created_at ON templates(created_at);
CREATE INDEX idx_templates_likes_count ON templates(likes_count DESC);
CREATE INDEX idx_templates_usage_count ON templates(usage_count DESC);
CREATE INDEX idx_templates_tags ON templates USING GIN(tags);
CREATE INDEX idx_templates_tech_stack ON templates USING GIN(tech_stack);
```

#### 2.2 æç¤ºè¯è¡¨ (prompts)

```sql
CREATE TABLE prompts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(100),
    scenario TEXT,
    role VARCHAR(50),
    language VARCHAR(20) DEFAULT 'zh',
    model VARCHAR(50) DEFAULT 'gemini-2.5-flash',
    efficiency_score INTEGER CHECK (efficiency_score >= 0 AND efficiency_score <= 100),
    author_id UUID REFERENCES users(id),
    is_system BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT TRUE,
    status prompt_status DEFAULT 'draft',
    tags TEXT[],
    metadata JSONB DEFAULT '{}',
    likes_count INTEGER DEFAULT 0,
    usage_count INTEGER DEFAULT 0,
    views_count INTEGER DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0.00,
    rating_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE prompt_status AS ENUM ('draft', 'pending_review', 'approved', 'rejected', 'archived');

-- ç´¢å¼•
CREATE INDEX idx_prompts_author_id ON prompts(author_id);
CREATE INDEX idx_prompts_category ON prompts(category);
CREATE INDEX idx_prompts_role ON prompts(role);
CREATE INDEX idx_prompts_status ON prompts(status);
CREATE INDEX idx_prompts_is_public ON prompts(is_public);
CREATE INDEX idx_prompts_efficiency_score ON prompts(efficiency_score DESC);
CREATE INDEX idx_prompts_usage_count ON prompts(usage_count DESC);
CREATE INDEX idx_prompts_tags ON prompts USING GIN(tags);
```

#### 2.3 æŒ‡å—è¡¨ (guides)

```sql
CREATE TABLE guides (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(100),
    tool_name VARCHAR(100),
    official_url TEXT,
    read_time INTEGER, -- é¢„ä¼°é˜…è¯»æ—¶é—´(åˆ†é’Ÿ)
    language VARCHAR(20) DEFAULT 'zh',
    is_learning_path BOOLEAN DEFAULT FALSE,
    estimated_duration INTEGER, -- é¢„ä¼°å®Œæˆæ—¶é—´(åˆ†é’Ÿ)
    difficulty guide_difficulty DEFAULT 'beginner',
    prerequisites TEXT[],
    learning_objectives TEXT[],
    author_id UUID REFERENCES users(id),
    is_system BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT TRUE,
    status guide_status DEFAULT 'draft',
    metadata JSONB DEFAULT '{}',
    likes_count INTEGER DEFAULT 0,
    usage_count INTEGER DEFAULT 0,
    views_count INTEGER DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0.00,
    rating_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE guide_difficulty AS ENUM ('beginner', 'intermediate', 'advanced');
CREATE TYPE guide_status AS ENUM ('draft', 'pending_review', 'approved', 'rejected', 'archived');

-- ç´¢å¼•
CREATE INDEX idx_guides_author_id ON guides(author_id);
CREATE INDEX idx_guides_category ON guides(category);
CREATE INDEX idx_guides_tool_name ON guides(tool_name);
CREATE INDEX idx_guides_is_learning_path ON guides(is_learning_path);
CREATE INDEX idx_guides_difficulty ON guides(difficulty);
CREATE INDEX idx_guides_status ON guides(status);
CREATE INDEX idx_guides_is_public ON guides(is_public);
CREATE INDEX idx_guides_usage_count ON guides(usage_count DESC);
```

---

### 3. å­¦ä¹ è·¯å¾„æ¨¡å—

#### 3.1 å­¦ä¹ è·¯å¾„ç« èŠ‚è¡¨ (learning_path_sections)

```sql
CREATE TABLE learning_path_sections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    guide_id UUID NOT NULL REFERENCES guides(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    order_index INTEGER NOT NULL,
    duration INTEGER, -- é¢„ä¼°å­¦ä¹ æ—¶é—´(åˆ†é’Ÿ)
    is_completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_learning_path_sections_guide_id ON learning_path_sections(guide_id);
CREATE INDEX idx_learning_path_sections_order ON learning_path_sections(guide_id, order_index);
```

#### 3.2 æµ‹éªŒè¡¨ (quizzes)

```sql
CREATE TABLE quizzes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    section_id UUID NOT NULL REFERENCES learning_path_sections(id) ON DELETE CASCADE,
    question TEXT NOT NULL,
    options TEXT[] NOT NULL,
    correct_answer INTEGER NOT NULL,
    explanation TEXT,
    order_index INTEGER NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quizzes_section_id ON quizzes(section_id);
CREATE INDEX idx_quizzes_order ON quizzes(section_id, order_index);
```

#### 3.3 ç”¨æˆ·å­¦ä¹ è¿›åº¦è¡¨ (user_learning_progress)

```sql
CREATE TABLE user_learning_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    guide_id UUID NOT NULL REFERENCES guides(id) ON DELETE CASCADE,
    section_id UUID REFERENCES learning_path_sections(id) ON DELETE CASCADE,
    status progress_status DEFAULT 'not_started',
    completed_at TIMESTAMPTZ,
    time_spent INTEGER DEFAULT 0, -- å­¦ä¹ æ—¶é—´(ç§’)
    quiz_scores JSONB DEFAULT '{}', -- å„æ¬¡æµ‹éªŒå¾—åˆ†
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, guide_id, section_id)
);

CREATE TYPE progress_status AS ENUM ('not_started', 'in_progress', 'completed');
CREATE INDEX idx_user_learning_progress_user_id ON user_learning_progress(user_id);
CREATE INDEX idx_user_learning_progress_guide_id ON user_learning_progress(guide_id);
CREATE INDEX idx_user_learning_progress_status ON user_learning_progress(status);
```

---

### 4. ç”¨æˆ·äº¤äº’æ¨¡å—

#### 4.1 æ”¶è—è¡¨ (bookmarks)

```sql
CREATE TABLE bookmarks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    resource_type bookmark_type NOT NULL,
    resource_id UUID NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, resource_type, resource_id)
);

CREATE TYPE bookmark_type AS ENUM ('template', 'prompt', 'guide');
CREATE INDEX idx_bookmarks_user_id ON bookmarks(user_id);
CREATE INDEX idx_bookmarks_resource ON bookmarks(resource_type, resource_id);
CREATE INDEX idx_bookmarks_created_at ON bookmarks(created_at DESC);
```

#### 4.2 ç‚¹èµè¡¨ (likes)

```sql
CREATE TABLE likes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    resource_type like_type NOT NULL,
    resource_id UUID NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, resource_type, resource_id)
);

CREATE TYPE like_type AS ENUM ('template', 'prompt', 'guide', 'comment');
CREATE INDEX idx_likes_user_id ON likes(user_id);
CREATE INDEX idx_likes_resource ON likes(resource_type, resource_id);
```

#### 4.3 è¯„è®ºè¡¨ (comments)

```sql
CREATE TABLE comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    resource_type comment_type NOT NULL,
    resource_id UUID NOT NULL,
    parent_id UUID REFERENCES comments(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    status comment_status DEFAULT 'published',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE comment_type AS ENUM ('template', 'prompt', 'guide');
CREATE TYPE comment_status AS ENUM ('published', 'hidden', 'deleted');

CREATE INDEX idx_comments_user_id ON comments(user_id);
CREATE INDEX idx_comments_resource ON comments(resource_type, resource_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);
CREATE INDEX idx_comments_created_at ON comments(created_at DESC);
```

#### 4.4 è¯„åˆ†è¡¨ (ratings)

```sql
CREATE TABLE ratings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    resource_type rating_type NOT NULL,
    resource_id UUID NOT NULL,
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    review TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, resource_type, resource_id)
);

CREATE TYPE rating_type AS ENUM ('template', 'prompt', 'guide');
CREATE INDEX idx_ratings_user_id ON ratings(user_id);
CREATE INDEX idx_ratings_resource ON ratings(resource_type, resource_id);
CREATE INDEX idx_ratings_rating ON ratings(rating);
```

---

### 5. AIæœåŠ¡æ¨¡å—

#### 5.1 AIå¯¹è¯ä¼šè¯è¡¨ (ai_conversations)

```sql
CREATE TABLE ai_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255),
    model VARCHAR(50) DEFAULT 'gemini-2.5-flash',
    context JSONB DEFAULT '{}',
    total_tokens INTEGER DEFAULT 0,
    total_cost DECIMAL(10,4) DEFAULT 0.0000,
    status conversation_status DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE conversation_status AS ENUM ('active', 'archived', 'deleted');
CREATE INDEX idx_ai_conversations_user_id ON ai_conversations(user_id);
CREATE INDEX idx_ai_conversations_status ON ai_conversations(status);
CREATE INDEX idx_ai_conversations_created_at ON ai_conversations(created_at DESC);
```

#### 5.2 AIå¯¹è¯æ¶ˆæ¯è¡¨ (ai_messages)

```sql
CREATE TABLE ai_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES ai_conversations(id) ON DELETE CASCADE,
    role message_role NOT NULL,
    content TEXT NOT NULL,
    tokens INTEGER DEFAULT 0,
    cost DECIMAL(10,4) DEFAULT 0.0000,
    model VARCHAR(50),
    temperature DECIMAL(3,2),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE message_role AS ENUM ('user', 'assistant', 'system');

CREATE INDEX idx_ai_messages_conversation_id ON ai_messages(conversation_id);
CREATE INDEX idx_ai_messages_role ON ai_messages(role);
CREATE INDEX idx_ai_messages_created_at ON ai_messages(conversation_id, created_at);
```

#### 5.3 ä»£ç ç”Ÿæˆè®°å½•è¡¨ (code_generations)

```sql
CREATE TABLE code_generations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    prompt TEXT NOT NULL,
    context TEXT,
    generated_code TEXT NOT NULL,
    language VARCHAR(50),
    framework VARCHAR(50),
    template_id UUID REFERENCES templates(id),
    tokens_used INTEGER DEFAULT 0,
    cost DECIMAL(10,4) DEFAULT 0.0000,
    model VARCHAR(50) DEFAULT 'gemini-2.5-flash',
    temperature DECIMAL(3,2),
    user_feedback generation_feedback,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE generation_feedback AS ENUM ('helpful', 'not_helpful', 'partially_helpful', 'inappropriate');

CREATE INDEX idx_code_generations_user_id ON code_generations(user_id);
CREATE INDEX idx_code_generations_template_id ON code_generations(template_id);
CREATE INDEX idx_code_generations_language ON code_generations(language);
CREATE INDEX idx_code_generations_created_at ON code_generations(created_at DESC);
```

#### 5.4 ä»£ç åˆ†æè®°å½•è¡¨ (code_analyses)

```sql
CREATE TABLE code_analyses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    code TEXT NOT NULL,
    language VARCHAR(50),
    analysis_type TEXT[],
    overall_score INTEGER CHECK (overall_score >= 0 AND overall_score <= 100),
    metrics JSONB DEFAULT '{}',
    issues JSONB DEFAULT '[]',
    suggestions JSONB DEFAULT '[]',
    summary TEXT,
    tokens_used INTEGER DEFAULT 0,
    cost DECIMAL(10,4) DEFAULT 0.0000,
    model VARCHAR(50) DEFAULT 'gemini-2.5-flash',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_code_analyses_user_id ON code_analyses(user_id);
CREATE INDEX idx_code_analyses_language ON code_analyses(language);
CREATE INDEX idx_code_analyses_overall_score ON code_analyses(overall_score);
CREATE INDEX idx_code_analyses_created_at ON code_analyses(created_at DESC);
```

---

### 6. ç³»ç»Ÿç®¡ç†æ¨¡å—

#### 6.1 ç³»ç»Ÿé…ç½®è¡¨ (system_configs)

```sql
CREATE TABLE system_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key VARCHAR(255) UNIQUE NOT NULL,
    value JSONB NOT NULL,
    description TEXT,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_system_configs_key ON system_configs(key);
CREATE INDEX idx_system_configs_is_public ON system_configs(is_public);
```

#### 6.2 å®¡è®¡æ—¥å¿—è¡¨ (audit_logs)

```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id UUID,
    ip_address INET,
    user_agent TEXT,
    request_data JSONB,
    response_status INTEGER,
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
CREATE INDEX idx_audit_logs_success ON audit_logs(success);
```

#### 6.3 ä½¿ç”¨ç»Ÿè®¡è¡¨ (usage_statistics)

```sql
CREATE TABLE usage_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    metric_name VARCHAR(100) NOT NULL,
    metric_value BIGINT DEFAULT 0,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, date, metric_name)
);

CREATE INDEX idx_usage_statistics_user_id ON usage_statistics(user_id);
CREATE INDEX idx_usage_statistics_date ON usage_statistics(date);
CREATE INDEX idx_usage_statistics_metric_name ON usage_statistics(metric_name);
```

---

## ğŸ”§ æ•°æ®åº“å‡½æ•°å’Œè§¦å‘å™¨

### 1. æ›´æ–°æ—¶é—´æˆ³å‡½æ•°

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- ä¸ºæ‰€æœ‰éœ€è¦çš„è¡¨åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_templates_updated_at BEFORE UPDATE ON templates 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_prompts_updated_at BEFORE UPDATE ON prompts 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ... å…¶ä»–è¡¨çš„è§¦å‘å™¨
```

### 2. è®¡æ•°å™¨æ›´æ–°å‡½æ•°

```sql
-- æ›´æ–°æ¨¡æ¿ç‚¹èµæ•°
CREATE OR REPLACE FUNCTION update_template_likes_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE templates SET likes_count = likes_count + 1 WHERE id = NEW.resource_id;
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE templates SET likes_count = likes_count - 1 WHERE id = OLD.resource_id;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ language 'plpgsql';

CREATE TRIGGER trigger_update_template_likes
    AFTER INSERT OR DELETE ON likes
    FOR EACH ROW EXECUTE FUNCTION update_template_likes_count()
    WHEN (NEW.resource_type = 'template' OR OLD.resource_type = 'template');

-- æ›´æ–°ä½¿ç”¨æ¬¡æ•°
CREATE OR REPLACE FUNCTION increment_template_usage_count()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE templates SET usage_count = usage_count + 1 WHERE id = NEW.template_id;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trigger_increment_template_usage
    AFTER INSERT ON code_generations
    FOR EACH ROW EXECUTE FUNCTION increment_template_usage_count();
```

### 3. ç»Ÿè®¡æ•°æ®èšåˆå‡½æ•°

```sql
-- æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡
CREATE OR REPLACE FUNCTION update_daily_usage_stats()
RETURNS void AS $$
DECLARE
    today DATE := CURRENT_DATE;
BEGIN
    INSERT INTO usage_statistics (user_id, date, metric_name, metric_value)
    SELECT 
        user_id,
        today,
        'ai_requests',
        COUNT(*)
    FROM code_generations 
    WHERE DATE(created_at) = today
    GROUP BY user_id
    ON CONFLICT (user_id, date, metric_name) 
    DO UPDATE SET metric_value = EXCLUDED.metric_value;
    
    -- æ›´æ–°tokenä½¿ç”¨ç»Ÿè®¡
    INSERT INTO usage_statistics (user_id, date, metric_name, metric_value)
    SELECT 
        user_id,
        today,
        'tokens_used',
        SUM(tokens_used)
    FROM code_generations 
    WHERE DATE(created_at) = today
    GROUP BY user_id
    ON CONFLICT (user_id, date, metric_name) 
    DO UPDATE SET metric_value = usage_statistics.metric_value + EXCLUDED.metric_value;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼ˆéœ€è¦pg_cronæ‰©å±•ï¼‰
SELECT cron.schedule('update-daily-usage', '0 1 * * *', 'SELECT update_daily_usage_stats();');
```

---

## ğŸš€ æ•°æ®è¿ç§»è„šæœ¬

### 1. åˆå§‹åŒ–è„šæœ¬ (init.sql)

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE nexus_ai_platform;
CREATE USER nexus_app WITH PASSWORD 'secure_password_here';
GRANT ALL PRIVILEGES ON DATABASE nexus_ai_platform TO nexus_app;

-- è¿æ¥åˆ°æ•°æ®åº“
\c nexus_ai_platform;

-- å¯ç”¨æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
CREATE EXTENSION IF NOT EXISTS "btree_gin";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

-- æ‰§è¡Œæ‰€æœ‰è¡¨åˆ›å»ºè„šæœ¬
-- (è¿™é‡ŒåŒ…å«ä¸Šé¢æ‰€æœ‰çš„CREATE TABLEè¯­å¥)
```

### 2. ç§å­æ•°æ®è„šæœ¬ (seed.sql)

```sql
-- åˆ›å»ºç³»ç»Ÿç”¨æˆ·
INSERT INTO users (id, email, username, password_hash, role, is_system, email_verified) VALUES
('00000000-0000-0000-0000-000000000001', 'system@nexus-ai.com', 'system', '$2b$10$...', 'super_admin', TRUE, TRUE);

-- åˆ›å»ºç³»ç»Ÿé…ç½®
INSERT INTO system_configs (key, value, description, is_public) VALUES
('app.version', '"1.0.0"', 'åº”ç”¨ç¨‹åºç‰ˆæœ¬', TRUE),
('ai.default_model', '"gemini-2.5-flash"', 'é»˜è®¤AIæ¨¡å‹', TRUE),
('user.free_plan_limits', '{"ai_requests": 100, "templates": 5, "storage": 104857600}', 'å…è´¹ç”¨æˆ·é™åˆ¶', FALSE),
('pricing.plans', '[
  {
    "id": "free",
    "name": "å…è´¹ç‰ˆ",
    "price": 0,
    "features": {
      "ai_requests": 100,
      "templates": 5,
      "storage": 104857600
    }
  }
]', 'å®šä»·æ–¹æ¡ˆ', FALSE);

-- å¯¼å…¥ç°æœ‰æ¨¡æ¿æ•°æ®
INSERT INTO templates (id, title, description, content, stage, tech_stack, is_system, is_public, status) VALUES
-- (è¿™é‡Œå¯ä»¥å¯¼å…¥constants.tsä¸­çš„æ¨¡æ¿æ•°æ®)
;
```

### 3. æ•°æ®åº“å‡çº§è„šæœ¬ (migrations/)

```sql
-- migrations/001_initial_schema.sql
-- migrations/002_add_bookmarks.sql
-- migrations/003_add_ai_conversations.sql
-- migrations/004_add_rating_system.sql

-- æ¯ä¸ªè¿ç§»æ–‡ä»¶éƒ½åº”è¯¥æœ‰upå’Œdownç‰ˆæœ¬
-- migrations/001_initial_schema_up.sql
-- migrations/001_initial_schema_down.sql
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- å¤åˆç´¢å¼•
CREATE INDEX idx_templates_public_featured ON templates(is_public, is_featured, created_at DESC) WHERE is_public = TRUE;
CREATE INDEX idx_templates_stage_difficulty ON templates(stage, difficulty, likes_count DESC);
CREATE INDEX idx_prompts_category_role ON prompts(category, role, efficiency_score DESC);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_active_users ON users(id) WHERE status = 'active';
CREATE INDEX idx_public_templates ON templates(id, title) WHERE is_public = TRUE;
CREATE INDEX idx_pending_reviews ON templates(id, created_at) WHERE status = 'pending_review';

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_lower_email ON users(LOWER(email));
CREATE INDEX idx_templates_search ON templates USING GIN(to_tsvector('english', title || ' ' || description));
```

### 2. åˆ†åŒºç­–ç•¥

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºå¤§è¡¨
CREATE TABLE audit_logs_y2024m01 PARTITION OF audit_logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE audit_logs_y2024m02 PARTITION OF audit_logs
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºçš„å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_y' || to_char(start_date, 'YYYY') || 'm' || to_char(start_date, 'MM');
    end_date := start_date + interval '1 month';
    
    EXECUTE format('CREATE TABLE %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

### 3. æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ç”¨äºå¤æ‚æŸ¥è¯¢
CREATE MATERIALIZED VIEW template_stats AS
SELECT 
    t.id,
    t.title,
    t.stage,
    t.likes_count,
    t.usage_count,
    t.views_count,
    u.username as author_name,
    COALESCE(AVG(r.rating), 0) as avg_rating,
    COUNT(r.rating) as rating_count
FROM templates t
LEFT JOIN users u ON t.author_id = u.id
LEFT JOIN ratings r ON r.resource_id = t.id AND r.resource_type = 'template'
WHERE t.is_public = TRUE AND t.status = 'approved'
GROUP BY t.id, t.title, t.stage, t.likes_count, t.usage_count, t.views_count, u.username;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_template_stats_id ON template_stats(id);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
CREATE OR REPLACE FUNCTION refresh_template_stats()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY template_stats;
END;
$$ LANGUAGE plpgsql;

-- æ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡
SELECT cron.schedule('refresh-template-stats', '0 * * * *', 'SELECT refresh_template_stats();');
```

---

## ğŸ”’ æ•°æ®å®‰å…¨ç­–ç•¥

### 1. è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_conversations ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY user_preferences_policy ON user_preferences
    FOR ALL TO authenticated_user
    USING (user_id = current_setting('app.current_user_id')::UUID);

CREATE POLICY ai_conversations_policy ON ai_conversations
    FOR ALL TO authenticated_user
    USING (user_id = current_setting('app.current_user_id')::UUID);
```

### 2. æ•°æ®åŠ å¯†

```sql
-- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data text)
RETURNS text AS $$
BEGIN
    RETURN encode(encrypt(data::bytea, 'encryption_key_here', 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- è§£å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data text)
RETURNS text AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_data, 'base64'), 'encryption_key_here', 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§æŸ¥è¯¢

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 2. å®šæœŸç»´æŠ¤è„šæœ¬

```sql
-- æ¸…ç†æ—§æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS void AS $$
BEGIN
    -- åˆ é™¤30å¤©å‰çš„å®¡è®¡æ—¥å¿—
    DELETE FROM audit_logs WHERE created_at < NOW() - interval '30 days';
    
    -- åˆ é™¤90å¤©å‰çš„ä»£ç ç”Ÿæˆè®°å½•
    DELETE FROM code_generations WHERE created_at < NOW() - interval '90 days';
    
    -- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    ANALYZE;
    
    -- é‡å»ºç´¢å¼•
    REINDEX DATABASE CONCURRENTLY nexus_ai_platform;
END;
$$ LANGUAGE plpgsql;

-- æ¯å‘¨æ‰§è¡Œä¸€æ¬¡æ¸…ç†
SELECT cron.schedule('weekly-cleanup', '0 2 * * 0', 'SELECT cleanup_old_data();');
```

---

## ğŸš€ éƒ¨ç½²é…ç½®

### 1. Dockeré…ç½®

```dockerfile
# Dockerfile
FROM postgres:15-alpine

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY ./database/init.sql /docker-entrypoint-initdb.d/01-init.sql
COPY ./database/seed.sql /docker-entrypoint-initdb.d/02-seed.sql
COPY ./database/migrations/ /docker-entrypoint-initdb.d/migrations/

# è®¾ç½®æƒé™
RUN chmod +x /docker-entrypoint-initdb.d/*.sql

EXPOSE 5432
```

### 2. docker-compose.yml

```yaml
version: '3.8'
services:
  postgres:
    build: ./database
    environment:
      POSTGRES_DB: nexus_ai_platform
      POSTGRES_USER: nexus_app
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/backups:/backups
    ports:
      - "5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  elasticsearch:
    image: elasticsearch:8.8.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  es_data:
```

### 3. è¿æ¥æ± é…ç½®

```typescript
// database/config.ts
import { Pool } from 'pg';

const pool = new Pool({
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT || '5432'),
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20, // æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000, // ç©ºé—²è¶…æ—¶
  connectionTimeoutMillis: 2000, // è¿æ¥è¶…æ—¶
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

export default pool;
```

---

## ğŸ“ æ€»ç»“

è¿™ä¸ªæ•°æ®åº“è®¾è®¡æ–¹æ¡ˆä¸ºNexus AIå¹³å°æä¾›äº†ï¼š

### âœ… æ ¸å¿ƒç‰¹æ€§
- **å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ** - è®¤è¯ã€æƒé™ã€è®¢é˜…
- **ä¸°å¯Œçš„å†…å®¹ç®¡ç†** - æ¨¡æ¿ã€æç¤ºè¯ã€æŒ‡å—
- **å¼ºå¤§çš„AIæœåŠ¡æ”¯æŒ** - å¯¹è¯ã€ä»£ç ç”Ÿæˆã€åˆ†æ
- **å…¨é¢çš„æ•°æ®ç»Ÿè®¡** - ä½¿ç”¨é‡ã€æ€§èƒ½ã€ç”¨æˆ·è¡Œä¸º

### ğŸš€ æŠ€æœ¯ä¼˜åŠ¿
- **é«˜æ€§èƒ½** - ä¼˜åŒ–çš„ç´¢å¼•å’Œåˆ†åŒºç­–ç•¥
- **å¯æ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
- **å®‰å…¨æ€§** - è¡Œçº§å®‰å…¨ã€æ•°æ®åŠ å¯†ã€å®¡è®¡æ—¥å¿—
- **ç›‘æ§æ€§** - å®Œå–„çš„ç›‘æ§å’Œç»´æŠ¤æ–¹æ¡ˆ

### ğŸ“Š é¢„ä¼°è§„æ¨¡
- **ç”¨æˆ·é‡**: æ”¯æŒ100ä¸‡+ç”¨æˆ·
- **æ•°æ®é‡**: TBçº§åˆ«æ•°æ®å­˜å‚¨
- **å¹¶å‘**: æ”¯æŒ10000+ QPS
- **å¯ç”¨æ€§**: 99.9%+ æœåŠ¡å¯ç”¨æ€§

è¿™ä¸ªè®¾è®¡å¯ä»¥æ”¯æ’‘é¡¹ç›®ä»MVPåˆ°å¤§è§„æ¨¡å•†ä¸šåŒ–è¿è¥çš„å…¨ç”Ÿå‘½å‘¨æœŸéœ€æ±‚ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2024å¹´1æœˆ15æ—¥*  
*è®¾è®¡å›¢é˜Ÿ: Nexus AIæŠ€æœ¯å›¢é˜Ÿ*