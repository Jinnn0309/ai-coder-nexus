# Nexus AI Platform - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´12æœˆ2æ—¥  
**ä½œè€…**: æ•°æ®åº“å›¢é˜Ÿ  
**å®¡æ ¸äºº**: æ•°æ®æ¶æ„å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº  

---

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ•°æ®åº“ç±»å‹** | PostgreSQL 15+ |
| **ORMæ¡†æ¶** | Prisma 5.6+ |
| **è®¾è®¡æ¨¡å¼** | å¾®æœåŠ¡æ•°æ®åº“ã€è¯»å†™åˆ†ç¦» |
| **å­—ç¬¦é›†** | UTF-8 |
| **æ—¶åŒº** | UTC |

---

## 1. æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

### 1.1 æ¶æ„è®¾è®¡

#### å¾®æœåŠ¡æ•°æ®åº“æ¶æ„
```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A[ç”¨æˆ·æœåŠ¡]
        B[æ¨¡æ¿æœåŠ¡]
        C[æç¤ºè¯æœåŠ¡]
        D[AIæœåŠ¡]
        E[åˆ†ææœåŠ¡]
    end
    
    subgraph "æ•°æ®åº“å±‚"
        F[(ç”¨æˆ·æ•°æ®åº“<br/>nexus_users)]
        G[(æ¨¡æ¿æ•°æ®åº“<br/>nexus_templates)]
        H[(æç¤ºè¯æ•°æ®åº“<br/>nexus_prompts)]
        I[(AIæ•°æ®åº“<br/>nexus_ai)]
        J[(åˆ†ææ•°æ®åº“<br/>nexus_analytics)]
    end
    
    subgraph "å…±äº«æœåŠ¡"
        K[(Redisç¼“å­˜)]
        L[(Elasticsearch)]
    end
    
    A --> F
    A --> K
    B --> G
    B --> K
    B --> L
    C --> H
    C --> K
    C --> L
    D --> I
    D --> K
    E --> J
    E --> K
```

#### è¯»å†™åˆ†ç¦»æ¶æ„
```mermaid
graph LR
    A[åº”ç”¨æœåŠ¡] --> B[è¯»å†™ä»£ç†]
    B --> C[ä¸»æ•°æ®åº“<br/>å†™æ“ä½œ]
    B --> D[ä»æ•°æ®åº“<br/>è¯»æ“ä½œ]
    C --> E[åŒæ­¥å¤åˆ¶]
    E --> D
```

### 1.2 æ•°æ®åº“é€‰æ‹©ç†ç”±

#### PostgreSQLä¼˜åŠ¿
- **ACIDäº‹åŠ¡**: ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **JSONæ”¯æŒ**: çµæ´»çš„æ•°æ®ç»“æ„
- **å…¨æ–‡æœç´¢**: å†…ç½®æœç´¢åŠŸèƒ½
- **æ‰©å±•æ€§å¼º**: æ”¯æŒå¤šç§æ‰©å±•
- **å¼€æºç¨³å®š**: æˆç†Ÿçš„å¼€æºæ•°æ®åº“

#### Redisä¼˜åŠ¿
- **é«˜æ€§èƒ½**: å†…å­˜å­˜å‚¨ï¼Œæå¿«å“åº”
- **æ•°æ®ç»“æ„ä¸°å¯Œ**: æ”¯æŒå¤šç§æ•°æ®ç±»å‹
- **æŒä¹…åŒ–**: æ”¯æŒRDBå’ŒAOFæŒä¹…åŒ–
- **é«˜å¯ç”¨**: æ”¯æŒé›†ç¾¤å’Œå“¨å…µæ¨¡å¼

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 ç”¨æˆ·æœåŠ¡æ•°æ®åº“ (nexus_users)

#### 2.1.1 ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    salt VARCHAR(255) NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    avatar_url VARCHAR(500),
    bio TEXT,
    
    -- è§’è‰²å’ŒçŠ¶æ€
    role VARCHAR(20) NOT NULL DEFAULT 'developer',
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    email_verified BOOLEAN DEFAULT false,
    is_premium BOOLEAN DEFAULT false,
    
    -- åå¥½è®¾ç½®
    preferences JSONB DEFAULT '{}',
    language VARCHAR(10) DEFAULT 'en',
    timezone VARCHAR(50) DEFAULT 'UTC',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,
    last_active_at TIMESTAMP WITH TIME ZONE,
    
    -- çº¦æŸ
    CONSTRAINT users_role_check CHECK (role IN ('admin', 'developer', 'product_manager', 'qa_engineer')),
    CONSTRAINT users_status_check CHECK (status IN ('active', 'inactive', 'suspended', 'deleted'))
);

-- ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_last_active_at ON users(last_active_at);

-- GINç´¢å¼•ç”¨äºJSONBæŸ¥è¯¢
CREATE INDEX idx_users_preferences ON users USING GIN(preferences);
```

#### 2.1.2 ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)

```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ä¼šè¯ä¿¡æ¯
    session_token VARCHAR(255) NOT NULL UNIQUE,
    refresh_token VARCHAR(255) NOT NULL UNIQUE,
    device_info JSONB,
    ip_address INET,
    user_agent TEXT,
    
    -- çŠ¶æ€å’Œæ—¶é—´
    is_active BOOLEAN DEFAULT true,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_accessed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_session_token ON user_sessions(session_token);
CREATE INDEX idx_user_sessions_refresh_token ON user_sessions(refresh_token);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_user_sessions_is_active ON user_sessions(is_active);
```

#### 2.1.3 ç”¨æˆ·ç»Ÿè®¡è¡¨ (user_statistics)

```sql
CREATE TABLE user_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ç»Ÿè®¡æ•°æ®
    templates_created INTEGER DEFAULT 0,
    templates_used INTEGER DEFAULT 0,
    prompts_created INTEGER DEFAULT 0,
    prompts_used INTEGER DEFAULT 0,
    ai_calls_made INTEGER DEFAULT 0,
    total_time_saved_minutes INTEGER DEFAULT 0,
    
    -- æ•ˆç‡è¯„åˆ†
    efficiency_score DECIMAL(5,2) DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0,
    
    -- æ—¶é—´ç»´åº¦
    date DATE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    UNIQUE(user_id, date)
);

-- ç´¢å¼•
CREATE INDEX idx_user_statistics_user_id ON user_statistics(user_id);
CREATE INDEX idx_user_statistics_date ON user_statistics(date);
CREATE UNIQUE INDEX idx_user_statistics_user_date ON user_statistics(user_id, date);
```

### 2.2 æ¨¡æ¿æœåŠ¡æ•°æ®åº“ (nexus_templates)

#### 2.2.1 æ¨¡æ¿è¡¨ (templates)

```sql
CREATE TABLE templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- åŸºæœ¬ä¿¡æ¯
    title VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    content TEXT NOT NULL, -- å®Œæ•´çš„æç¤ºè¯å†…å®¹
    
    -- åˆ†ç±»ä¿¡æ¯
    stage VARCHAR(50) NOT NULL,
    tech_stack TEXT[] DEFAULT '{}',
    app_types TEXT[] DEFAULT '{}',
    supports TEXT[] DEFAULT '{}',
    
    -- è¾“å…¥è¾“å‡ºæ ¼å¼
    input_format TEXT,
    output_format TEXT,
    preview_content TEXT,
    
    -- ç»Ÿè®¡ä¿¡æ¯
    likes_count INTEGER DEFAULT 0,
    usage_count INTEGER DEFAULT 0,
    views_count INTEGER DEFAULT 0,
    comments_count INTEGER DEFAULT 0,
    
    -- çŠ¶æ€å’Œæ ‡è®°
    is_public BOOLEAN DEFAULT true,
    is_pinned BOOLEAN DEFAULT false,
    is_system BOOLEAN DEFAULT false,
    status VARCHAR(20) DEFAULT 'active',
    
    -- ä½œè€…ä¿¡æ¯
    author_id UUID NOT NULL,
    
    -- æ‰©å±•å­—æ®µ
    tags TEXT[] DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP WITH TIME ZONE,
    
    -- çº¦æŸ
    CONSTRAINT templates_stage_check CHECK (stage IN ('requirements', 'product_planning', 'architecture', 'story_creation', 'development', 'qa')),
    CONSTRAINT templates_status_check CHECK (status IN ('active', 'draft', 'archived', 'deleted'))
);

-- ç´¢å¼•
CREATE INDEX idx_templates_author_id ON templates(author_id);
CREATE INDEX idx_templates_stage ON templates(stage);
CREATE INDEX idx_templates_status ON templates(status);
CREATE INDEX idx_templates_is_public ON templates(is_public);
CREATE INDEX idx_templates_is_pinned ON templates(is_pinned);
CREATE INDEX idx_templates_is_system ON templates(is_system);
CREATE INDEX idx_templates_created_at ON templates(created_at);
CREATE INDEX idx_templates_updated_at ON templates(updated_at);
CREATE INDEX idx_templates_likes_count ON templates(likes_count DESC);
CREATE INDEX idx_templates_usage_count ON templates(usage_count DESC);

-- GINç´¢å¼•ç”¨äºæ•°ç»„æœç´¢
CREATE INDEX idx_templates_tech_stack ON templates USING GIN(tech_stack);
CREATE INDEX idx_templates_app_types ON templates USING GIN(app_types);
CREATE INDEX idx_templates_supports ON templates USING GIN(supports);
CREATE INDEX idx_templates_tags ON templates USING GIN(tags);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_templates_search ON templates USING GIN(
    to_tsvector('english', title || ' ' || description || ' ' || COALESCE(content, ''))
);
```

#### 2.2.2 æ¨¡æ¿ä½¿ç”¨è®°å½•è¡¨ (template_usage)

```sql
CREATE TABLE template_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL,
    user_id UUID NOT NULL,
    
    -- ä½¿ç”¨ä¿¡æ¯
    context JSONB DEFAULT '{}',
    input_data JSONB DEFAULT '{}',
    output_data JSONB DEFAULT '{}',
    execution_time_ms INTEGER,
    
    -- è´¨é‡è¯„ä¼°
    user_rating INTEGER CHECK (user_rating >= 1 AND user_rating <= 5),
    user_feedback TEXT,
    
    -- æ—¶é—´ä¿¡æ¯
    used_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_template_usage_template_id ON template_usage(template_id);
CREATE INDEX idx_template_usage_user_id ON template_usage(user_id);
CREATE INDEX idx_template_usage_used_at ON template_usage(used_at);
CREATE INDEX idx_template_usage_user_rating ON template_usage(user_rating);
```

#### 2.2.3 æ¨¡æ¿è¯„è®ºè¡¨ (template_comments)

```sql
CREATE TABLE template_comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL,
    user_id UUID NOT NULL,
    
    -- è¯„è®ºå†…å®¹
    content TEXT NOT NULL,
    parent_id UUID REFERENCES template_comments(id), -- æ”¯æŒå›å¤
    
    -- çŠ¶æ€ä¿¡æ¯
    is_deleted BOOLEAN DEFAULT false,
    is_edited BOOLEAN DEFAULT false,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_template_comments_template_id ON template_comments(template_id);
CREATE INDEX idx_template_comments_user_id ON template_comments(user_id);
CREATE INDEX idx_template_comments_parent_id ON template_comments(parent_id);
CREATE INDEX idx_template_comments_created_at ON template_comments(created_at);
CREATE INDEX idx_template_comments_is_deleted ON template_comments(is_deleted);
```

#### 2.2.4 æ¨¡æ¿æ”¶è—è¡¨ (template_favorites)

```sql
CREATE TABLE template_favorites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL,
    user_id UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE,
    UNIQUE(template_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_template_favorites_template_id ON template_favorites(template_id);
CREATE INDEX idx_template_favorites_user_id ON template_favorites(user_id);
```

### 2.3 æç¤ºè¯æœåŠ¡æ•°æ®åº“ (nexus_prompts)

#### 2.3.1 æç¤ºè¯è¡¨ (prompts)

```sql
CREATE TABLE prompts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- åŸºæœ¬ä¿¡æ¯
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    description TEXT,
    
    -- åˆ†ç±»ä¿¡æ¯
    role VARCHAR(50) NOT NULL,
    category VARCHAR(50) NOT NULL,
    tech_stack TEXT[] DEFAULT '{}',
    
    -- æ•ˆç‡è¯„ä¼°
    efficiency_score DECIMAL(5,2) DEFAULT 0,
    average_rating DECIMAL(3,2) DEFAULT 0,
    
    -- ç»Ÿè®¡ä¿¡æ¯
    usage_count INTEGER DEFAULT 0,
    likes_count INTEGER DEFAULT 0,
    comments_count INTEGER DEFAULT 0,
    
    -- çŠ¶æ€ä¿¡æ¯
    is_public BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    status VARCHAR(20) DEFAULT 'active',
    
    -- ä½œè€…ä¿¡æ¯
    author_id UUID NOT NULL,
    
    -- æ‰©å±•å­—æ®µ
    tags TEXT[] DEFAULT '{}',
    examples JSONB DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP WITH TIME ZONE,
    
    -- çº¦æŸ
    CONSTRAINT prompts_role_check CHECK (role IN ('frontend_developer', 'backend_developer', 'qa_engineer', 'product_manager', 'devops_engineer', 'ui_ux_designer')),
    CONSTRAINT prompts_category_check CHECK (category IN ('code_generation', 'optimization', 'documentation', 'debugging', 'testing', 'architecture')),
    CONSTRAINT prompts_status_check CHECK (status IN ('active', 'draft', 'archived', 'deleted'))
);

-- ç´¢å¼•
CREATE INDEX idx_prompts_author_id ON prompts(author_id);
CREATE INDEX idx_prompts_role ON prompts(role);
CREATE INDEX idx_prompts_category ON prompts(category);
CREATE INDEX idx_prompts_status ON prompts(status);
CREATE INDEX idx_prompts_is_public ON prompts(is_public);
CREATE INDEX idx_prompts_is_featured ON prompts(is_featured);
CREATE INDEX idx_prompts_created_at ON prompts(created_at);
CREATE INDEX idx_prompts_efficiency_score ON prompts(efficiency_score DESC);
CREATE INDEX idx_prompts_average_rating ON prompts(average_rating DESC);
CREATE INDEX idx_prompts_usage_count ON prompts(usage_count DESC);

-- GINç´¢å¼•ç”¨äºæ•°ç»„æœç´¢
CREATE INDEX idx_prompts_tech_stack ON prompts USING GIN(tech_stack);
CREATE INDEX idx_prompts_tags ON prompts USING GIN(tags);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_prompts_search ON prompts USING GIN(
    to_tsvector('english', title || ' ' || COALESCE(description, '') || ' ' || COALESCE(content, ''))
);
```

#### 2.3.2 æç¤ºè¯è¯„ä»·è¡¨ (prompt_ratings)

```sql
CREATE TABLE prompt_ratings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    prompt_id UUID NOT NULL,
    user_id UUID NOT NULL,
    
    -- è¯„åˆ†ä¿¡æ¯
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    helpfulness INTEGER CHECK (helpfulness >= 1 AND helpfulness <= 5),
    accuracy INTEGER CHECK (accuracy >= 1 AND accuracy <= 5),
    completeness INTEGER CHECK (completeness >= 1 AND completeness <= 5),
    comment TEXT,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    UNIQUE(prompt_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_prompt_ratings_prompt_id ON prompt_ratings(prompt_id);
CREATE INDEX idx_prompt_ratings_user_id ON prompt_ratings(user_id);
CREATE INDEX idx_prompt_ratings_rating ON prompt_ratings(rating);
```

### 2.4 AIæœåŠ¡æ•°æ®åº“ (nexus_ai)

#### 2.4.1 AIå¯¹è¯è®°å½•è¡¨ (ai_conversations)

```sql
CREATE TABLE ai_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    
    -- å¯¹è¯ä¿¡æ¯
    title VARCHAR(200),
    model VARCHAR(50) NOT NULL,
    context JSONB DEFAULT '{}',
    
    -- ç»Ÿè®¡ä¿¡æ¯
    message_count INTEGER DEFAULT 0,
    total_tokens INTEGER DEFAULT 0,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_message_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_ai_conversations_user_id ON ai_conversations(user_id);
CREATE INDEX idx_ai_conversations_model ON ai_conversations(model);
CREATE INDEX idx_ai_conversations_created_at ON ai_conversations(created_at);
CREATE INDEX idx_ai_conversations_updated_at ON ai_conversations(updated_at);
```

#### 2.4.2 AIæ¶ˆæ¯è¡¨ (ai_messages)

```sql
CREATE TABLE ai_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL,
    
    -- æ¶ˆæ¯ä¿¡æ¯
    role VARCHAR(20) NOT NULL, -- 'user' | 'assistant' | 'system'
    content TEXT NOT NULL,
    metadata JSONB DEFAULT '{}',
    
    -- ä½¿ç”¨ç»Ÿè®¡
    prompt_tokens INTEGER,
    completion_tokens INTEGER,
    total_tokens INTEGER,
    execution_time_ms INTEGER,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (conversation_id) REFERENCES ai_conversations(id) ON DELETE CASCADE,
    
    -- çº¦æŸ
    CONSTRAINT ai_messages_role_check CHECK (role IN ('user', 'assistant', 'system'))
);

-- ç´¢å¼•
CREATE INDEX idx_ai_messages_conversation_id ON ai_messages(conversation_id);
CREATE INDEX idx_ai_messages_role ON ai_messages(role);
CREATE INDEX idx_ai_messages_created_at ON ai_messages(created_at);
```

#### 2.4.3 ä»£ç åˆ†æè®°å½•è¡¨ (code_analysis)

```sql
CREATE TABLE code_analysis (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    
    -- ä»£ç ä¿¡æ¯
    code_content TEXT NOT NULL,
    language VARCHAR(50) NOT NULL,
    analysis_type VARCHAR(50) NOT NULL,
    framework VARCHAR(50),
    
    -- åˆ†æç»“æœ
    score INTEGER CHECK (score >= 0 AND score <= 100),
    issues JSONB DEFAULT '[]',
    suggestions JSONB DEFAULT '[]',
    metrics JSONB DEFAULT '{}',
    
    -- æ‰§è¡Œä¿¡æ¯
    model VARCHAR(50) NOT NULL,
    execution_time_ms INTEGER,
    tokens_used INTEGER,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT code_analysis_type_check CHECK (analysis_type IN ('quality', 'security', 'performance', 'readability'))
);

-- ç´¢å¼•
CREATE INDEX idx_code_analysis_user_id ON code_analysis(user_id);
CREATE INDEX idx_code_analysis_language ON code_analysis(language);
CREATE INDEX idx_code_analysis_analysis_type ON code_analysis(analysis_type);
CREATE INDEX idx_code_analysis_score ON code_analysis(score);
CREATE INDEX idx_code_analysis_created_at ON code_analysis(created_at);
```

### 2.5 åˆ†ææœåŠ¡æ•°æ®åº“ (nexus_analytics)

#### 2.5.1 ç³»ç»Ÿäº‹ä»¶è¡¨ (system_events)

```sql
CREATE TABLE system_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- äº‹ä»¶ä¿¡æ¯
    event_type VARCHAR(100) NOT NULL,
    event_name VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id UUID,
    
    -- ç”¨æˆ·ä¿¡æ¯
    user_id UUID,
    session_id UUID,
    
    -- äº‹ä»¶æ•°æ®
    data JSONB DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    
    -- æŠ€æœ¯ä¿¡æ¯
    ip_address INET,
    user_agent TEXT,
    referrer_url TEXT,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_system_events_event_type ON system_events(event_type);
CREATE INDEX idx_system_events_event_name ON system_events(event_name);
CREATE INDEX idx_system_events_resource_type ON system_events(resource_type);
CREATE INDEX idx_system_events_resource_id ON system_events(resource_id);
CREATE INDEX idx_system_events_user_id ON system_events(user_id);
CREATE INDEX idx_system_events_created_at ON system_events(created_at);
CREATE INDEX idx_system_events_data ON system_events USING GIN(data);
```

#### 2.5.2 æ€§èƒ½æŒ‡æ ‡è¡¨ (performance_metrics)

```sql
CREATE TABLE performance_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- æŒ‡æ ‡ä¿¡æ¯
    metric_name VARCHAR(100) NOT NULL,
    metric_type VARCHAR(50) NOT NULL, -- 'counter' | 'gauge' | 'histogram'
    service_name VARCHAR(100) NOT NULL,
    
    -- æŒ‡æ ‡å€¼
    value DECIMAL(15,6) NOT NULL,
    unit VARCHAR(20),
    
    -- æ ‡ç­¾
    tags JSONB DEFAULT '{}',
    
    -- æ—¶é—´ä¿¡æ¯
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- çº¦æŸ
    CONSTRAINT performance_metrics_type_check CHECK (metric_type IN ('counter', 'gauge', 'histogram'))
);

-- ç´¢å¼•
CREATE INDEX idx_performance_metrics_metric_name ON performance_metrics(metric_name);
CREATE INDEX idx_performance_metrics_service_name ON performance_metrics(service_name);
CREATE INDEX idx_performance_metrics_timestamp ON performance_metrics(timestamp);
CREATE INDEX idx_performance_metrics_tags ON performance_metrics USING GIN(tags);
```

---

## 3. æ•°æ®åº“è¿ç§»

### 3.1 è¿ç§»ç­–ç•¥

#### ç‰ˆæœ¬åŒ–è¿ç§»
```typescript
// Prismaè¿ç§»ç¤ºä¾‹
// 001_initial_schema.prisma
model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String    @unique
  username        String    @unique
  passwordHash    String    @map("password_hash")
  role            UserRole  @default(DEVELOPER)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@map("users")
}

// 002_add_user_preferences.prisma
model User {
  // ... ç°æœ‰å­—æ®µ
  
  preferences     Json?     @default("{}")
  language        String?   @default("en")
  timezone        String?   @default("UTC")
  
  @@map("users")
}
```

#### è¿ç§»è„šæœ¬ç¤ºä¾‹
```sql
-- 001_create_users_table.sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'developer',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 002_add_user_preferences.sql
ALTER TABLE users 
ADD COLUMN preferences JSONB DEFAULT '{}',
ADD COLUMN language VARCHAR(10) DEFAULT 'en',
ADD COLUMN timezone VARCHAR(50) DEFAULT 'UTC';
```

### 3.2 æ•°æ®è¿ç§»æœ€ä½³å®è·µ

#### è¿ç§»å‰æ£€æŸ¥æ¸…å•
- [ ] å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
- [ ] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»è„šæœ¬
- [ ] å‡†å¤‡å›æ»šè„šæœ¬
- [ ] ç¡®è®¤è¿ç§»æ—¶é—´çª—å£
- [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿ

#### è¿ç§»æ‰§è¡Œæ­¥éª¤
1. **å‡†å¤‡é˜¶æ®µ**: åˆ›å»ºè¿ç§»åˆ†æ”¯ï¼Œç¼–å†™è¿ç§»è„šæœ¬
2. **æµ‹è¯•é˜¶æ®µ**: åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œå¹¶éªŒè¯
3. **é¢„æ¼”é˜¶æ®µ**: åœ¨é¢„ç”Ÿäº§ç¯å¢ƒå®Œæ•´æµ‹è¯•
4. **æ‰§è¡Œé˜¶æ®µ**: åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»
5. **éªŒè¯é˜¶æ®µ**: éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œåº”ç”¨åŠŸèƒ½
6. **æ¸…ç†é˜¶æ®µ**: æ¸…ç†ä¸´æ—¶æ•°æ®å’Œè„šæœ¬

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•ç­–ç•¥

#### å¤åˆç´¢å¼•
```sql
-- ç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_users_role_status_created ON users(role, status, created_at DESC);

-- æ¨¡æ¿æœç´¢ä¼˜åŒ–
CREATE INDEX idx_templates_stage_public_pinned_created ON templates(stage, is_public, is_pinned, created_at DESC);

-- æç¤ºè¯è¯„ä»·ä¼˜åŒ–
CREATE INDEX idx_prompt_ratings_prompt_rating_created ON prompt_ratings(prompt_id, rating DESC, created_at DESC);
```

#### éƒ¨åˆ†ç´¢å¼•
```sql
-- åªç´¢å¼•æ´»è·ƒç”¨æˆ·
CREATE INDEX idx_users_active_last_active ON users(last_active_at DESC) 
WHERE status = 'active';

-- åªç´¢å¼•å·²å‘å¸ƒçš„æ¨¡æ¿
CREATE INDEX idx_templates_published_created ON templates(created_at DESC) 
WHERE status = 'active' AND is_public = true;
```

#### è¡¨è¾¾å¼ç´¢å¼•
```sql
-- å…¨æ–‡æœç´¢ä¼˜åŒ–
CREATE INDEX idx_templates_title_search ON templates USING GIN(
    to_tsvector('english', title)
);

-- æ—¥æœŸæŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_user_statistics_date_trunc ON user_statistics(
    date_trunc('month', date)
);
```

### 4.2 æŸ¥è¯¢ä¼˜åŒ–

#### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£OFFSET
SELECT * FROM templates 
WHERE stage = 'development' 
  AND created_at < '2024-12-01 10:00:00'::timestamp
ORDER BY created_at DESC 
LIMIT 20;

-- é¿å…ä½¿ç”¨OFFSETçš„å¤§åç§»é‡
-- âŒ é¿å…è¿™æ ·åš
SELECT * FROM templates ORDER BY created_at DESC OFFSET 10000 LIMIT 20;

-- âœ… æ¨èåšæ³•
SELECT * FROM templates 
WHERE created_at < (SELECT created_at FROM templates ORDER BY created_at DESC OFFSET 9999 LIMIT 1)
ORDER BY created_at DESC LIMIT 20;
```

#### JOINä¼˜åŒ–
```sql
-- é¢„åŠ è½½å…³è”æ•°æ®é¿å…N+1æŸ¥è¯¢
SELECT 
    t.*,
    a.username as author_name,
    a.avatar_url as author_avatar,
    COUNT(DISTINCT f.id) as favorites_count,
    COUNT(DISTINCT c.id) as comments_count
FROM templates t
LEFT JOIN users a ON t.author_id = a.id
LEFT JOIN template_favorites f ON t.id = f.template_id
LEFT JOIN template_comments c ON t.id = c.template_id AND c.is_deleted = false
WHERE t.stage = 'development' AND t.is_public = true
GROUP BY t.id, a.username, a.avatar_url
ORDER BY t.created_at DESC
LIMIT 20;
```

### 4.3 è¿æ¥æ± é…ç½®

#### PostgreSQLè¿æ¥æ± 
```typescript
// Prismaé…ç½®ç¤ºä¾‹
export const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  log: ['query', 'info', 'warn', 'error'],
});

// è¿æ¥æ± å‚æ•°
const poolConfig = {
  host: 'localhost',
  port: 5432,
  database: 'nexus_templates',
  user: 'nexus_user',
  password: 'password',
  max: 20,              // æœ€å¤§è¿æ¥æ•°
  min: 5,               // æœ€å°è¿æ¥æ•°
  acquire: 30000,       // è·å–è¿æ¥è¶…æ—¶(ms)
  idle: 10000,          // ç©ºé—²è¶…æ—¶(ms)
  handleDisconnects: true,
  connectionTimeoutMillis: 2000,
  idleTimeoutMillis: 30000,
  maxLifetimeMillis: 1800000,
};
```

---

## 5. æ•°æ®å¤‡ä»½ä¸æ¢å¤

### 5.1 å¤‡ä»½ç­–ç•¥

#### å®Œæ•´å¤‡ä»½
```bash
#!/bin/bash
# æ¯æ—¥å®Œæ•´å¤‡ä»½è„šæœ¬

DB_NAME="nexus_templates"
BACKUP_DIR="/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_full_$DATE.sql"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå®Œæ•´å¤‡ä»½
pg_dump -h localhost -U nexus_user -d $DB_NAME \
  --format=custom \
  --compress=9 \
  --verbose \
  --file=$BACKUP_FILE

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_FILE

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_FILE.gz"
```

#### å¢é‡å¤‡ä»½
```bash
#!/bin/bash
# æ¯å°æ—¶å¢é‡å¤‡ä»½(WALå½’æ¡£)

# å¯ç”¨WALå½’æ¡£
ALTER SYSTEM SET wal_level = replica;
ALTER SYSTEM SET archive_mode = on;
ALTER SYSTEM SET archive_command = 'cp %p /backups/postgresql/wal/%f';

# é‡å¯PostgreSQLä½¿é…ç½®ç”Ÿæ•ˆ
pg_ctl restart -D /var/lib/postgresql/data

# WALå½’æ¡£è„šæœ¬
ARCHIVE_DIR="/backups/postgresql/wal"
DATE=$(date +%Y%m%d)
mkdir -p $ARCHIVE_DIR/$DATE

# å½’æ¡£å½“å‰WALæ–‡ä»¶
pg_receivewal -h localhost -U replication_user -D $ARCHIVE_DIR/$DATE -Z 9 --progress
```

### 5.2 æ¢å¤ç­–ç•¥

#### æ—¶é—´ç‚¹æ¢å¤
```bash
#!/bin/bash
# æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹

BACKUP_FILE="/backups/postgresql/nexus_templates_full_20241201_020000.sql"
TARGET_TIME="2024-12-01 15:30:00"

# åˆ›å»ºæ¢å¤ç›®å½•
RECOVERY_DIR="/tmp/postgresql_recovery"
mkdir -p $RECOVERY_DIR

# æ¢å¤åŸºç¡€å¤‡ä»½
pg_restore -h localhost -U nexus_user -d nexus_templates_recovery \
  --verbose --clean --if-exists $BACKUP_FILE

# é…ç½®æ¢å¤å‚æ•°
cat >> $RECOVERY_DIR/recovery.conf << EOF
restore_command = 'cp /backups/postgresql/wal/%f %p'
recovery_target_time = '$TARGET_TIME'
EOF

# é‡å¯æ•°æ®åº“è¿›è¡Œæ¢å¤
pg_ctl stop -D /var/lib/postgresql/data
cp $RECOVERY_DIR/recovery.conf /var/lib/postgresql/data/
pg_ctl start -D /var/lib/postgresql/data

echo "Recovery completed to $TARGET_TIME"
```

---

## 6. ç›‘æ§ä¸ç»´æŠ¤

### 6.1 æ€§èƒ½ç›‘æ§

#### å…³é”®æŒ‡æ ‡ç›‘æ§
```sql
-- æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements 
WHERE mean_time > 1000 
ORDER BY mean_time DESC 
LIMIT 10;

-- ç›‘æ§è¡¨å¤§å°
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY schemaname, tablename;
```

#### è‡ªåŠ¨æ¸…ç†é…ç½®
```sql
-- é…ç½®è‡ªåŠ¨æ¸…ç†
ALTER SYSTEM SET autovacuum = on;
ALTER SYSTEM SET autovacuum_max_workers = 3;
ALTER SYSTEM SET autovacuum_naptime = '1min';

-- è¡¨çº§åˆ«çš„è‡ªåŠ¨æ¸…ç†é…ç½®
ALTER TABLE templates SET (
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_analyze_scale_factor = 0.05,
    autovacuum_vacuum_threshold = 1000
);
```

### 6.2 å®šæœŸç»´æŠ¤ä»»åŠ¡

#### ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
```sql
-- æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE templates;
ANALYZE prompts;
ANALYZE users;

-- æ‰¹é‡æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
REINDEX DATABASE nexus_templates;
REINDEX DATABASE nexus_prompts;
```

#### è¡¨ç»´æŠ¤
```sql
-- æ¸…ç†å·²åˆ é™¤æ•°æ®
VACUUM FULL templates;
VACUUM FULL prompts;

-- é‡å»ºç´¢å¼•
REINDEX INDEX idx_templates_search;
REINDEX INDEX idx_prompts_search;
```

---

## 7. å®‰å…¨è®¾è®¡

### 7.1 æ•°æ®åŠ å¯†

#### æ•æ„Ÿå­—æ®µåŠ å¯†
```sql
-- åˆ›å»ºåŠ å¯†æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å‡½æ•°ç¤ºä¾‹
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data TEXT, key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(encrypt(data::bytea, key::bytea, 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;

-- è§£å¯†å‡½æ•°ç¤ºä¾‹
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data TEXT, key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_data, 'base64'), key::bytea, 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql;
```

#### æ•°æ®è„±æ•
```sql
-- é‚®ç®±è„±æ•å‡½æ•°
CREATE OR REPLACE FUNCTION mask_email(email TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN SUBSTRING(email FROM 1 FOR 2) || '***@' || SPLIT_PART(email, '@', 2);
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT 
    id,
    username,
    mask_email(email) as masked_email
FROM users;
```

### 7.2 è®¿é—®æ§åˆ¶

#### è¡Œçº§å®‰å…¨ç­–ç•¥
```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE templates ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„ç§æœ‰æ¨¡æ¿
CREATE POLICY user_templates_policy ON templates
FOR ALL TO application_user
USING (is_public = true OR author_id = current_setting('app.current_user_id')::uuid);

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ¨¡æ¿
CREATE POLICY admin_templates_policy ON templates
FOR ALL TO admin_user
USING (true);
```

#### æ•°æ®åº“è§’è‰²
```sql
-- åˆ›å»ºåº”ç”¨è§’è‰²
CREATE ROLE application_user;
CREATE ROLE readonly_user;
CREATE ROLE admin_user;

-- æˆäºˆæƒé™
GRANT CONNECT ON DATABASE nexus_templates TO application_user;
GRANT USAGE ON SCHEMA public TO application_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO application_user;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO application_user;

-- åªè¯»æƒé™
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- ç®¡ç†å‘˜æƒé™
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO admin_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO admin_user;
```

---

## 8. æ•°æ®åŒæ­¥ä¸å¤åˆ¶

### 8.1 ä¸»ä»å¤åˆ¶é…ç½®

#### ä¸»åº“é…ç½®
```sql
-- postgresql.conf
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
synchronous_commit = on
synchronous_standby_names = 'standby1'

-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE ROLE replication_user REPLICATION LOGIN CONNECTION LIMIT 3 ENCRYPTED PASSWORD 'replication_password';
```

#### ä»åº“é…ç½®
```sql
-- recovery.conf
standby_mode = 'on'
primary_conninfo = 'host=primary_host port=5432 user=replication_user password=replication_password'
restore_command = 'cp /archive/%f %p'
```

### 8.2 æ•°æ®ä¸€è‡´æ€§

#### å”¯ä¸€çº¦æŸ
```sql
-- ç¡®ä¿ç”¨æˆ·é‚®ç®±å”¯ä¸€
ALTER TABLE users ADD CONSTRAINT users_email_unique UNIQUE (email);

-- ç¡®ä¿æ¨¡æ¿æ ‡é¢˜åœ¨åŒä¸€ä½œè€…ä¸‹å”¯ä¸€
ALTER TABLE templates ADD CONSTRAINT templates_title_author_unique 
UNIQUE (title, author_id);

-- ç¡®ä¿æ”¶è—è®°å½•å”¯ä¸€
ALTER TABLE template_favorites ADD CONSTRAINT template_favorites_unique 
UNIQUE (template_id, user_id);
```

#### å¤–é”®çº¦æŸ
```sql
-- ç¡®ä¿å¼•ç”¨å®Œæ•´æ€§
ALTER TABLE template_comments 
ADD CONSTRAINT fk_template_comments_template 
FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE CASCADE;

ALTER TABLE template_comments 
ADD CONSTRAINT fk_template_comments_user 
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

---

## 9. å®¹é‡è§„åˆ’

### 9.1 å­˜å‚¨å®¹é‡ä¼°ç®—

#### æ•°æ®å¢é•¿æ¨¡å‹
```sql
-- é¢„ä¼°è¡¨å¤§å°
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as current_size,
    pg_total_relation_size(schemaname||'.'||tablename) as current_size_bytes,
    CASE 
        WHEN pg_total_relation_size(schemaname||'.'||tablename) > 0 THEN
            (pg_total_relation_size(schemaname||'.'||tablename) / NULLIF(
                (SELECT COUNT(*) FROM information_schema.columns 
                 WHERE table_schema = schemaname AND table_name = tablename), 0
            ))
        ELSE 0
    END as avg_row_size_bytes
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### å®¹é‡è§„åˆ’å»ºè®®
| è¡¨å | å½“å‰å¤§å° | å¹´å¢é•¿ç‡ | 1å¹´åé¢„ä¼° | 3å¹´åé¢„ä¼° |
|------|----------|----------|-----------|-----------|
| **users** | 50MB | 200% | 150MB | 1.2GB |
| **templates** | 200MB | 300% | 800MB | 8.6GB |
| **prompts** | 100MB | 400% | 500MB | 10.2GB |
| **ai_conversations** | 500MB | 500% | 3GB | 75GB |
| **system_events** | 1GB | 600% | 7GB | 252GB |

### 9.2 åˆ†åŒºç­–ç•¥

#### æ—¶é—´åˆ†åŒº
```sql
-- æŒ‰æœˆåˆ†åŒºç³»ç»Ÿäº‹ä»¶è¡¨
CREATE TABLE system_events_partitioned (
    LIKE system_events INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE system_events_2024_12 PARTITION OF system_events_partitioned
FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');

CREATE TABLE system_events_2025_01 PARTITION OF system_events_partitioned
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºçš„å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name TEXT, start_date DATE)
RETURNS VOID AS $$
DECLARE
    partition_name TEXT;
    end_date DATE;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';
    
    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF %I
                    FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

---

## 10. æ•…éšœå¤„ç†

### 10.1 å¸¸è§æ•…éšœåœºæ™¯

#### è¿æ¥æ± è€—å°½
```sql
-- ç›‘æ§è¿æ¥æ± çŠ¶æ€
SELECT 
    state,
    COUNT(*)
FROM pg_stat_activity 
WHERE datname = 'nexus_templates'
GROUP BY state;

-- æ¸…ç†ç©ºé—²è¿æ¥
SELECT pg_terminate_backend(pid) 
FROM pg_stat_activity 
WHERE state = 'idle' 
  AND query_start < now() - interval '1 hour';
```

#### é”ç­‰å¾…
```sql
-- æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SELECT 
    pg_class.relname,
    pg_locks.locktype,
    pg_locks.mode,
    pg_locks.granted,
    age(now(), pg_stat_activity.query_start) as age
FROM pg_locks
JOIN pg_class ON pg_locks.relation = pg_class.oid
JOIN pg_stat_activity ON pg_locks.pid = pg_stat_activity.pid
WHERE NOT granted
ORDER BY age DESC;
```

### 10.2 ç´§æ€¥æ¢å¤ç¨‹åº

#### æ•°æ®åº“æŸåæ¢å¤
```bash
#!/bin/bash
# ç´§æ€¥æ¢å¤è„šæœ¬

# 1. åœæ­¢åº”ç”¨æœåŠ¡
systemctl stop nexus-api

# 2. å¤‡ä»½å½“å‰æŸåæ•°æ®ï¼ˆå¦‚æœå¯èƒ½ï¼‰
pg_dumpall -h localhost -U postgres > /backups/emergency/backup_$(date +%Y%m%d_%H%M%S).sql

# 3. æ¢å¤æœ€è¿‘çš„å®Œæ•´å¤‡ä»½
LATEST_BACKUP=$(ls -t /backups/postgresql/*_full_*.sql.gz | head -1)
gunzip -c $LATEST_BACKUP | psql -h localhost -U postgres -d nexus_templates

# 4. åº”ç”¨WALæ—¥å¿—åˆ°æŒ‡å®šæ—¶é—´ç‚¹
pg_ctl stop -D /var/lib/postgresql/data
cp /var/lib/postgresql/data/postgresql.conf /tmp/postgresql.conf.bak

# æ·»åŠ æ¢å¤é…ç½®
echo "restore_command = 'cp /backups/postgresql/wal/%f %p'" >> /var/lib/postgresql/data/recovery.conf
echo "recovery_target_time = '$(date -d '1 hour ago' '+%Y-%m-%d %H:%M:%S')'" >> /var/lib/postgresql/data/recovery.conf

# 5. é‡å¯æ•°æ®åº“
pg_ctl start -D /var/lib/postgresql/data

echo "Emergency recovery completed"
```

---

## 11. æœ€ä½³å®è·µæ€»ç»“

### 11.1 è®¾è®¡åŸåˆ™
1. **æ•°æ®å®Œæ•´æ€§**: ä½¿ç”¨é€‚å½“çš„çº¦æŸç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **æ€§èƒ½ä¼˜å…ˆ**: åˆç†è®¾è®¡ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
3. **å¯æ‰©å±•æ€§**: é¢„ç•™æ‰©å±•ç©ºé—´ï¼Œæ”¯æŒæ°´å¹³åˆ†ç‰‡
4. **å®‰å…¨æ€§**: å®æ–½æ•°æ®åŠ å¯†å’Œè®¿é—®æ§åˆ¶
5. **å¯ç»´æŠ¤æ€§**: ä¿æŒæ¸…æ™°çš„è¡¨ç»“æ„å’Œå‘½åè§„èŒƒ

### 11.2 å¼€å‘è§„èŒƒ
1. **å‘½åè§„èŒƒ**: ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
2. **å­—æ®µè§„èŒƒ**: ç»Ÿä¸€ä½¿ç”¨UUIDä½œä¸ºä¸»é”®
3. **æ—¶é—´æˆ³**: æ‰€æœ‰è¡¨éƒ½åŒ…å«åˆ›å»ºå’Œæ›´æ–°æ—¶é—´
4. **è½¯åˆ é™¤**: é‡è¦æ•°æ®ä½¿ç”¨æ ‡è®°åˆ é™¤è€Œéç‰©ç†åˆ é™¤
5. **å®¡è®¡æ—¥å¿—**: å…³é”®æ“ä½œè®°å½•å˜æ›´å†å²

### 11.3 è¿ç»´è§„èŒƒ
1. **å®šæœŸå¤‡ä»½**: æ¯æ—¥å®Œæ•´å¤‡ä»½ï¼Œæ¯å°æ—¶å¢é‡å¤‡ä»½
2. **ç›‘æ§å‘Šè­¦**: å…³é”®æŒ‡æ ‡å®æ—¶ç›‘æ§å’Œå‘Šè­¦
3. **å®¹é‡è§„åˆ’**: å®šæœŸè¯„ä¼°å­˜å‚¨å’Œæ€§èƒ½éœ€æ±‚
4. **å®‰å…¨å®¡è®¡**: å®šæœŸæ£€æŸ¥æƒé™å’Œè®¿é—®æ—¥å¿—
5. **æ•…éšœæ¼”ç»ƒ**: å®šæœŸè¿›è¡Œæ•…éšœæ¢å¤æ¼”ç»ƒ

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2024å¹´12æœˆ2æ—¥*  
*ä¸‹æ¬¡è¯„å®¡: 2024å¹´12æœˆ16æ—¥*  
*çŠ¶æ€: å·²å®¡æ ¸*  
*è´Ÿè´£äºº: æ•°æ®åº“å›¢é˜Ÿ*