# Nexus AI Platform - éƒ¨ç½²æŒ‡å—

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´12æœˆ2æ—¥  
**ä½œè€…**: DevOpså›¢é˜Ÿ  
**å®¡æ ¸äºº**: ç³»ç»Ÿæ¶æ„å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº  

---

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **éƒ¨ç½²ç¯å¢ƒ** | Docker, Kubernetes, äº‘å¹³å° |
| **å®¹å™¨åŒ–** | Docker + Docker Compose |
| **ç¼–æ’å¹³å°** | Kubernetes (æ¨è) |
| **CI/CD** | GitHub Actions / GitLab CI |
| **ç›‘æ§å¹³å°** | Prometheus + Grafana |

---

## 1. éƒ¨ç½²æ¶æ„æ¦‚è§ˆ

### 1.1 éƒ¨ç½²ç¯å¢ƒè¯´æ˜

#### å¼€å‘ç¯å¢ƒ (Development)
- **ç›®çš„**: å¼€å‘äººå‘˜æ—¥å¸¸å¼€å‘å’Œæµ‹è¯•
- **éƒ¨ç½²æ–¹å¼**: Docker Compose
- **èµ„æºé…ç½®**: æœ€å°åŒ–é…ç½®
- **æ•°æ®æŒä¹…åŒ–**: æœ¬åœ°Volume
- **ç›‘æ§**: åŸºç¡€æ—¥å¿—æ”¶é›†

#### æµ‹è¯•ç¯å¢ƒ (Staging)
- **ç›®çš„**: é›†æˆæµ‹è¯•å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•
- **éƒ¨ç½²æ–¹å¼**: Kubernetes (å•èŠ‚ç‚¹)
- **èµ„æºé…ç½®**: ç”Ÿäº§ç¯å¢ƒçš„50%
- **æ•°æ®æŒä¹…åŒ–**: æŒä¹…åŒ–å·
- **ç›‘æ§**: å®Œæ•´ç›‘æ§ä½“ç³»

#### ç”Ÿäº§ç¯å¢ƒ (Production)
- **ç›®çš„**: æ­£å¼æœåŠ¡ç”¨æˆ·
- **éƒ¨ç½²æ–¹å¼**: Kubernetes (å¤šèŠ‚ç‚¹é›†ç¾¤)
- **èµ„æºé…ç½®**: é«˜å¯ç”¨é…ç½®
- **æ•°æ®æŒä¹…åŒ–**: åˆ†å¸ƒå¼å­˜å‚¨
- **ç›‘æ§**: å…¨é¢ç›‘æ§å‘Šè­¦

### 1.2 éƒ¨ç½²æ¶æ„å›¾

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        LB[Load Balancer<br/>Nginx/HAProxy]
        CDN[CDN<br/>CloudFlare]
    end
    
    subgraph "Kubernetesé›†ç¾¤"
        subgraph "å‰ç«¯æœåŠ¡"
            FE[Frontend Pods<br/>React App]
        end
        
        subgraph "APIç½‘å…³"
            GW[API Gateway<br/>Kong/Nginx]
        end
        
        subgraph "å¾®æœåŠ¡"
            US[User Service]
            TS[Template Service]
            PS[Prompt Service]
            AS[AI Service]
        end
        
        subgraph "æ•°æ®å±‚"
            PG[(PostgreSQL<br/>ä¸»ä»)]
            RD[(Redis Cluster)]
            ES[(Elasticsearch)]
            MINIO[(MinIO)]
        end
        
        subgraph "ç›‘æ§å±‚"
            PROM[Prometheus]
            GRAF[Grafana]
            LOG[ELK Stack]
        end
    end
    
    CDN --> LB
    LB --> GW
    GW --> FE
    GW --> US
    GW --> TS
    GW --> PS
    GW --> AS
    US --> PG
    TS --> PG
    PS --> PG
    AS --> PG
    US --> RD
    TS --> RD
    PS --> RD
    AS --> RD
    TS --> ES
    PS --> ES
    AS --> ES
    TS --> MINIO
    PS --> MINIO
    
    US --> PROM
    TS --> PROM
    PS --> PROM
    AS --> PROM
    PROM --> GRAF
    US --> LOG
    TS --> LOG
    PS --> LOG
    AS --> LOG
```

---

## 2. ç¯å¢ƒå‡†å¤‡

### 2.1 ç³»ç»Ÿè¦æ±‚

#### ç¡¬ä»¶è¦æ±‚

| ç¯å¢ƒ | CPU | å†…å­˜ | å­˜å‚¨ | ç½‘ç»œ |
|------|-----|------|------|------|
| **å¼€å‘ç¯å¢ƒ** | 4æ ¸ | 8GB | 100GB SSD | 100Mbps |
| **æµ‹è¯•ç¯å¢ƒ** | 8æ ¸ | 16GB | 500GB SSD | 1Gbps |
| **ç”Ÿäº§ç¯å¢ƒ** | 16æ ¸+ | 32GB+ | 1TB+ SSD | 10Gbps+ |

#### è½¯ä»¶è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| **æ“ä½œç³»ç»Ÿ** | Ubuntu 20.04+ / CentOS 8+ | Linuxå‘è¡Œç‰ˆ |
| **Docker** | 20.10+ | å®¹å™¨è¿è¡Œæ—¶ |
| **Docker Compose** | 2.0+ | å®¹å™¨ç¼–æ’(å¼€å‘ç¯å¢ƒ) |
| **Kubernetes** | 1.25+ | å®¹å™¨ç¼–æ’(æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ) |
| **Helm** | 3.8+ | KubernetesåŒ…ç®¡ç† |
| **Git** | 2.30+ | ç‰ˆæœ¬æ§åˆ¶ |

### 2.2 ä¾èµ–æœåŠ¡å®‰è£…

#### Dockerå®‰è£…
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# å°†ç”¨æˆ·æ·»åŠ åˆ°dockerç»„
sudo usermod -aG docker $USER

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### Kuberneteså®‰è£… (å•èŠ‚ç‚¹æµ‹è¯•ç¯å¢ƒ)
```bash
# ä½¿ç”¨kubeadmå®‰è£…Kubernetes
# 1. å®‰è£…kubeadm, kubelet, kubectl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

# 2. åˆå§‹åŒ–MasterèŠ‚ç‚¹
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# 3. é…ç½®kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 4. å®‰è£…ç½‘ç»œæ’ä»¶ (Flannel)
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

# 5. å…è®¸MasterèŠ‚ç‚¹è°ƒåº¦Pod (å•èŠ‚ç‚¹ç¯å¢ƒ)
kubectl taint nodes --all node-role.kubernetes.io/master-
```

---

## 3. Docker Composeéƒ¨ç½² (å¼€å‘ç¯å¢ƒ)

### 3.1 é¡¹ç›®ç»“æ„

```
ai-coder-nexus/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker-compose.override.yml
â”œâ”€â”€ .env
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”œâ”€â”€ backend/
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”œâ”€â”€ nginx/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ nginx.conf
â”‚   â””â”€â”€ postgres/
â”‚       â””â”€â”€ init.sql
â”œâ”€â”€ volumes/
â”‚   â”œâ”€â”€ postgres/
â”‚   â”œâ”€â”€ redis/
â”‚   â”œâ”€â”€ elasticsearch/
â”‚   â””â”€â”€ minio/
â””â”€â”€ scripts/
    â”œâ”€â”€ setup.sh
    â”œâ”€â”€ backup.sh
    â””â”€â”€ deploy.sh
```

### 3.2 Docker Composeé…ç½®

#### docker-compose.yml
```yaml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=http://localhost:8080/api/v1
      - REACT_APP_ENV=development
    depends_on:
      - api-gateway
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro

  # APIç½‘å…³
  api-gateway:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - user-service
      - template-service
      - prompt-service
    networks:
      - nexus-network

  # ç”¨æˆ·æœåŠ¡
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://nexus:password@postgres:5432/nexus_users
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
    depends_on:
      - postgres
      - redis
    volumes:
      - ./services/user-service:/app
      - /app/node_modules
    networks:
      - nexus-network

  # æ¨¡æ¿æœåŠ¡
  template-service:
    build:
      context: ./services/template-service
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://nexus:password@postgres:5432/nexus_templates
      - REDIS_URL=redis://redis:6379
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
    depends_on:
      - postgres
      - redis
      - elasticsearch
      - minio
    volumes:
      - ./services/template-service:/app
      - /app/node_modules
    networks:
      - nexus-network

  # æç¤ºè¯æœåŠ¡
  prompt-service:
    build:
      context: ./services/prompt-service
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://nexus:password@postgres:5432/nexus_prompts
      - REDIS_URL=redis://redis:6379
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    depends_on:
      - postgres
      - redis
      - elasticsearch
    volumes:
      - ./services/prompt-service:/app
      - /app/node_modules
    networks:
      - nexus-network

  # æ•°æ®åº“æœåŠ¡
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=nexus
      - POSTGRES_USER=nexus
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - nexus-network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - ./volumes/redis:/data
    networks:
      - nexus-network

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - ./volumes/elasticsearch:/usr/share/elasticsearch/data
    networks:
      - nexus-network

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./volumes/minio:/data
    networks:
      - nexus-network

networks:
  nexus-network:
    driver: bridge
```

#### docker-compose.override.yml (å¼€å‘ç¯å¢ƒè¦†ç›–)
```yaml
version: '3.8'

services:
  user-service:
    environment:
      - DEBUG=debug
      - LOG_LEVEL=debug
    volumes:
      - ./services/user-service/src:/app/src:ro
    command: npm run dev

  template-service:
    environment:
      - DEBUG=debug
      - LOG_LEVEL=debug
    volumes:
      - ./services/template-service/src:/app/src:ro
    command: npm run dev

  prompt-service:
    environment:
      - DEBUG=debug
      - LOG_LEVEL=debug
    volumes:
      - ./services/prompt-service/src:/app/src:ro
    command: npm run dev
```

#### .env ç¯å¢ƒå˜é‡é…ç½®
```bash
# åº”ç”¨é…ç½®
NODE_ENV=development
APP_VERSION=1.0.0
LOG_LEVEL=info

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://nexus:password@localhost:5432/nexus
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=redis_password_123

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-in-production
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# MinIOé…ç½®
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin123
MINIO_BUCKET=nexus-files

# AIæœåŠ¡é…ç½®
GEMINI_API_KEY=your-gemini-api-key
OPENAI_API_KEY=your-openai-api-key

# å¤–éƒ¨æœåŠ¡é…ç½®
ELASTICSEARCH_URL=http://localhost:9200
MINIO_ENDPOINT=localhost:9000

# é‚®ä»¶é…ç½® (å¯é€‰)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-email-password
```

### 3.3 Dockerfileç¤ºä¾‹

#### å‰ç«¯Dockerfile
```dockerfile
# docker/frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# ç”Ÿäº§ç¯å¢ƒ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®
COPY docker/nginx/nginx.conf /etc/nginx/nginx.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨nginx
CMD ["nginx", "-g", "daemon off;"]
```

#### åç«¯æœåŠ¡Dockerfile
```dockerfile
# docker/backend/Dockerfile
FROM node:20-alpine

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºTypeScript
RUN npm run build

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

USER nodejs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
```

### 3.4 éƒ¨ç½²è„šæœ¬

#### scripts/deploy.sh
```bash
#!/bin/bash
set -e

echo "ğŸš€ Starting Nexus AI Platform deployment..."

# æ£€æŸ¥Dockerå’ŒDocker Compose
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed. Please install Docker first."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose is not installed. Please install Docker Compose first."
    exit 1
fi

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
if [ ! -f .env ]; then
    echo "ğŸ“ Creating .env file from template..."
    cp .env.example .env
    echo "âš ï¸  Please edit .env file with your configuration before running this script again."
    exit 1
fi

# åˆ›å»ºå¿…è¦çš„ç›®å½•
echo "ğŸ“ Creating required directories..."
mkdir -p volumes/{postgres,redis,elasticsearch,minio}

# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
echo "ğŸ”¨ Building Docker images..."
docker-compose build

echo "ğŸš€ Starting services..."
docker-compose up -d

# ç­‰å¾…æ•°æ®åº“å¯åŠ¨
echo "â³ Waiting for database to be ready..."
sleep 10

# è¿è¡Œæ•°æ®åº“è¿ç§»
echo "ğŸ”„ Running database migrations..."
docker-compose exec user-service npm run migrate
docker-compose exec template-service npm run migrate
docker-compose exec prompt-service npm run migrate

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "âœ… Checking service status..."
docker-compose ps

echo "ğŸ‰ Deployment completed successfully!"
echo ""
echo "ğŸŒ Application URLs:"
echo "   Frontend: http://localhost:3000"
echo "   API Gateway: http://localhost:8080"
echo "   MinIO Console: http://localhost:9001"
echo ""
echo "ğŸ—„ï¸  Database URLs:"
echo "   PostgreSQL: postgresql://nexus:password@localhost:5432/nexus"
echo "   Redis: redis://localhost:6379"
echo "   Elasticsearch: http://localhost:9200"
echo ""
echo "ğŸ“Š Monitoring:"
echo "   View logs: docker-compose logs -f [service-name]"
echo "   Stop services: docker-compose down"
echo "   Restart services: docker-compose restart"
```

---

## 4. Kuberneteséƒ¨ç½² (ç”Ÿäº§ç¯å¢ƒ)

### 4.1 Helm Chartç»“æ„

```
helm/nexus-ai/
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ values.yaml
â”œâ”€â”€ values-dev.yaml
â”œâ”€â”€ values-staging.yaml
â”œâ”€â”€ values-prod.yaml
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â”œâ”€â”€ secret.yaml
â”‚   â”œâ”€â”€ pvc.yaml
â”‚   â”œâ”€â”€ hpa.yaml
â”‚   â”œâ”€â”€ rbac.yaml
â”‚   â””â”€â”€ helpers.tpl
â””â”€â”€ charts/
    â”œâ”€â”€ postgresql/
    â”œâ”€â”€ redis/
    â”œâ”€â”€ elasticsearch/
    â””â”€â”€ minio/
```

### 4.2 Helm Charté…ç½®

#### Chart.yaml
```yaml
apiVersion: v2
name: nexus-ai
description: Nexus AI Platform - AI Programming Assistant
type: application
version: 1.0.0
appVersion: "1.0.0"

keywords:
  - ai
  - programming
  - development
  - assistant

home: https://github.com/nexus-ai/nexus-ai-platform
sources:
  - https://github.com/nexus-ai/nexus-ai-platform

maintainers:
  - name: Nexus AI Team
    email: team@nexus-ai.com

dependencies:
  - name: postgresql
    version: 12.x.x
    repository: https://charts.bitnami.com/bitnami
    condition: postgresql.enabled
  - name: redis
    version: 17.x.x
    repository: https://charts.bitnami.com/bitnami
    condition: redis.enabled
  - name: elasticsearch
    version: 19.x.x
    repository: https://charts.bitnami.com/bitnami
    condition: elasticsearch.enabled
```

#### values.yaml (é»˜è®¤é…ç½®)
```yaml
# å…¨å±€é…ç½®
global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

# é•œåƒé…ç½®
image:
  registry: nexus-ai
  pullPolicy: IfNotPresent
  tag: "1.0.0"

# å‰¯æœ¬æ•°é…ç½®
replicaCount:
  frontend: 3
  apiGateway: 2
  userService: 3
  templateService: 3
  promptService: 3

# èµ„æºé…ç½®
resources:
  frontend:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  
  userService:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi
  
  templateService:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi
  
  promptService:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi

# æœåŠ¡é…ç½®
service:
  type: ClusterIP
  ports:
    frontend: 80
    apiGateway: 80
    userService: 3000
    templateService: 3000
    promptService: 3000

# Ingressé…ç½®
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: nexus-ai.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: nexus-ai-tls
      hosts:
        - nexus-ai.com

# è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# æŒä¹…åŒ–å­˜å‚¨é…ç½®
persistence:
  enabled: true
  storageClass: "fast-ssd"
  size:
    postgres: 100Gi
    redis: 20Gi
    elasticsearch: 500Gi
    minio: 1Ti

# é…ç½®æ–‡ä»¶
config:
  nodeEnv: production
  logLevel: info
  jwtSecret: ""
  jwtRefreshSecret: ""
  geminiApiKey: ""
  openaiApiKey: ""

# å¯†é’¥é…ç½®
secrets:
  databasePassword: ""
  redisPassword: ""
  minioAccessKey: ""
  minioSecretKey: ""

# ä¾èµ–æœåŠ¡é…ç½®
postgresql:
  enabled: true
  auth:
    postgresPassword: ""
    username: nexus
    database: nexus
  primary:
    persistence:
      enabled: true
      size: 100Gi

redis:
  enabled: true
  auth:
    enabled: true
    password: ""
  master:
    persistence:
      enabled: true
      size: 20Gi

elasticsearch:
  enabled: true
  master:
    replicaCount: 3
    persistence:
      enabled: true
      size: 100Gi
  data:
    replicaCount: 3
    persistence:
      enabled: true
      size: 400Gi
```

#### values-prod.yaml (ç”Ÿäº§ç¯å¢ƒé…ç½®)
```yaml
# ç”Ÿäº§ç¯å¢ƒè¦†ç›–é…ç½®
replicaCount:
  frontend: 5
  apiGateway: 3
  userService: 5
  templateService: 5
  promptService: 5

# ç”Ÿäº§èµ„æºé…ç½®
resources:
  frontend:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi
  
  userService:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi
  
  templateService:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi
  
  promptService:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi

# ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨æ‰©ç¼©å®¹
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# ç”Ÿäº§ç¯å¢ƒå­˜å‚¨
persistence:
  enabled: true
  storageClass: "ssd-premium"
  size:
    postgres: 500Gi
    redis: 100Gi
    elasticsearch: 2Ti
    minio: 5Ti

# ç”Ÿäº§ç¯å¢ƒä¾èµ–æœåŠ¡
postgresql:
  primary:
    replicaCount: 3
    persistence:
      size: 500Gi

redis:
  master:
    persistence:
      size: 100Gi
  replica:
    replicaCount: 2
    persistence:
      size: 100Gi

elasticsearch:
  master:
    replicaCount: 5
    persistence:
      size: 500Gi
  data:
    replicaCount: 5
    persistence:
      size: 1.5Ti
```

### 4.3 Kubernetesæ¨¡æ¿

#### deployment.yaml
```yaml
{{- range $service := list "frontend" "api-gateway" "user-service" "template-service" "prompt-service" }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $service }}
  labels:
    app: {{ $service }}
    component: nexus-ai
spec:
  {{- if eq $.Values.autoscaling.enabled false }}
  replicas: {{ index $.Values.replicaCount $service }}
  {{- end }}
  selector:
    matchLabels:
      app: {{ $service }}
  template:
    metadata:
      labels:
        app: {{ $service }}
        component: nexus-ai
    spec:
      containers:
      - name: {{ $service }}
        image: "{{ $.Values.image.registry }}/{{ $service }}:{{ $.Values.image.tag }}"
        imagePullPolicy: {{ $.Values.image.pullPolicy }}
        ports:
        - containerPort: {{ index $.Values.service.ports $service }}
        env:
        - name: NODE_ENV
          value: "{{ $.Values.config.nodeEnv }}"
        - name: LOG_LEVEL
          value: "{{ $.Values.config.logLevel }}"
        {{- if contains $service "service" }}
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: nexus-ai-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: nexus-ai-secrets
              key: redis-url
        {{- end }}
        {{- if contains $service "template" }}
        - name: ELASTICSEARCH_URL
          value: "http://elasticsearch:9200"
        - name: MINIO_ENDPOINT
          value: "minio:9000"
        {{- end }}
        resources:
          {{- toYaml (index $.Values.resources $service) | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /health
            port: {{ index $.Values.service.ports $service }}
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: {{ index $.Values.service.ports $service }}
          initialDelaySeconds: 5
          periodSeconds: 5
{{- end }}
```

#### service.yaml
```yaml
{{- range $service := list "frontend" "api-gateway" "user-service" "template-service" "prompt-service" }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $service }}
  labels:
    app: {{ $service }}
    component: nexus-ai
spec:
  type: {{ $.Values.service.type }}
  ports:
  - port: {{ index $.Values.service.ports $service }}
    targetPort: {{ index $.Values.service.ports $service }}
    protocol: TCP
    name: http
  selector:
    app: {{ $service }}
{{- end }}
```

#### ingress.yaml
```yaml
{{- if $.Values.ingress.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nexus-ai-ingress
  labels:
    component: nexus-ai
  annotations:
    {{- toYaml $.Values.ingress.annotations | nindent 4 }}
spec:
  ingressClassName: {{ $.Values.ingress.className }}
  tls:
    {{- toYaml $.Values.ingress.tls | nindent 4 }}
  rules:
    {{- range $.Values.ingress.hosts }}
    - host: {{ .host }}
      http:
        paths:
        {{- range .paths }}
        - path: {{ .path }}
          pathType: {{ .pathType }}
          backend:
            service:
              name: nexus-ai-frontend
              port:
                number: 80
        {{- end }}
    {{- end }}
{{- end }}
```

### 4.4 éƒ¨ç½²è„šæœ¬

#### scripts/k8s-deploy.sh
```bash
#!/bin/bash
set -e

# é…ç½®å˜é‡
NAMESPACE=${1:-nexus-ai}
ENVIRONMENT=${2:-staging}
CHART_PATH="./helm/nexus-ai"

echo "ğŸš€ Deploying Nexus AI Platform to namespace: $NAMESPACE, environment: $ENVIRONMENT"

# æ£€æŸ¥kubectl
if ! command -v kubectl &> /dev/null; then
    echo "âŒ kubectl is not installed. Please install kubectl first."
    exit 1
fi

# æ£€æŸ¥helm
if ! command -v helm &> /dev/null; then
    echo "âŒ Helm is not installed. Please install Helm first."
    exit 1
fi

# åˆ›å»ºå‘½åç©ºé—´
echo "ğŸ“ Creating namespace: $NAMESPACE"
kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# æ·»åŠ Helmä»“åº“
echo "ğŸ“¦ Adding Helm repositories..."
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# åˆ›å»ºå¯†é’¥
echo "ğŸ” Creating secrets..."
kubectl create secret generic nexus-ai-secrets \
  --from-literal=database-url="${DATABASE_URL}" \
  --from-literal=redis-url="${REDIS_URL}" \
  --from-literal=jwt-secret="${JWT_SECRET}" \
  --from-literal=jwt-refresh-secret="${JWT_REFRESH_SECRET}" \
  --from-literal=gemini-api-key="${GEMINI_API_KEY}" \
  --from-literal=openai-api-key="${OPENAI_API_KEY}" \
  --namespace=$NAMESPACE \
  --dry-run=client -o yaml | kubectl apply -f -

# éƒ¨ç½²åº”ç”¨
echo "ğŸš€ Deploying application..."
helm upgrade --install nexus-ai $CHART_PATH \
  --namespace=$NAMESPACE \
  --values=$CHART_PATH/values.yaml \
  --values=$CHART_PATH/values-${ENVIRONMENT}.yaml \
  --timeout=10m \
  --wait

# éªŒè¯éƒ¨ç½²
echo "âœ… Verifying deployment..."
kubectl get pods -n=$NAMESPACE
kubectl get services -n=$NAMESPACE

echo "ğŸ‰ Deployment completed successfully!"
echo ""
echo "ğŸ“Š To check the status:"
echo "   kubectl get pods -n=$NAMESPACE"
echo "   kubectl get services -n=$NAMESPACE"
echo ""
echo "ğŸ“ To view logs:"
echo "   kubectl logs -f deployment/nexus-ai-frontend -n=$NAMESPACE"
echo ""
echo "ğŸ—‘ï¸  To uninstall:"
echo "   helm uninstall nexus-ai -n=$NAMESPACE"
```

---

## 5. CI/CDé…ç½®

### 5.1 GitHub Actions

#### .github/workflows/ci-cd.yml
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: nexus-ai

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: nexus_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        cd services/user-service && npm ci
        cd ../template-service && npm ci
        cd ../prompt-service && npm ci

    - name: Run linting
      run: npm run lint

    - name: Run type checking
      run: npm run type-check

    - name: Run unit tests
      run: npm run test:unit
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nexus_test
        REDIS_URL: redis://localhost:6379

    - name: Run integration tests
      run: npm run test:integration
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nexus_test
        REDIS_URL: redis://localhost:6379

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.25.0'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig

    - name: Deploy to staging
      run: |
        export KUBECONFIG=kubeconfig
        ./scripts/k8s-deploy.sh nexus-ai staging
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        REDIS_URL: ${{ secrets.REDIS_URL_STAGING }}
        JWT_SECRET: ${{ secrets.JWT_SECRET_STAGING }}
        JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET_STAGING }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.25.0'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig

    - name: Deploy to production
      run: |
        export KUBECONFIG=kubeconfig
        ./scripts/k8s-deploy.sh nexus-ai production
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        REDIS_URL: ${{ secrets.REDIS_URL_PROD }}
        JWT_SECRET: ${{ secrets.JWT_SECRET_PROD }}
        JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET_PROD }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
```

### 5.2 GitLab CI/CD

#### .gitlab-ci.yml
```yaml
stages:
  - test
  - build
  - deploy-staging
  - deploy-production

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# æµ‹è¯•é˜¶æ®µ
test:
  stage: test
  image: node:20-alpine
  services:
    - postgres:15
    - redis:7-alpine
  variables:
    POSTGRES_DB: nexus_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: postgresql://postgres:postgres@postgres:5432/nexus_test
    REDIS_URL: redis://redis:6379
  before_script:
    - apk add --no-cache docker
    - npm ci
  script:
    - npm run lint
    - npm run type-check
    - npm run test:unit
    - npm run test:integration
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  only:
    - branches

# æ„å»ºé˜¶æ®µ
build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - docker buildx create --use
    - docker buildx build --push --platform linux/amd64,linux/arm64 -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE:latest .
  only:
    - main
    - tags

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  before_script:
    - kubectl config use-context $KUBE_CONTEXT_STAGING
  script:
    - helm upgrade --install nexus-ai ./helm/nexus-ai --namespace=nexus-ai-staging --set image.tag=$CI_COMMIT_SHA --values ./helm/nexus-ai/values-staging.yaml
  environment:
    name: staging
    url: https://staging.nexus-ai.com
  only:
    - main

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy-production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  before_script:
    - kubectl config use-context $KUBE_CONTEXT_PRODUCTION
  script:
    - helm upgrade --install nexus-ai ./helm/nexus-ai --namespace=nexus-ai-production --set image.tag=$CI_COMMIT_SHA --values ./helm/nexus-ai/values-production.yaml
  environment:
    name: production
    url: https://nexus-ai.com
  when: manual
  only:
    - tags
```

---

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 ç›‘æ§é…ç½®

#### Prometheusé…ç½® (prometheus.yml)
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "nexus-ai-rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  # Kubernetes API Server
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
    - role: endpoints
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
      action: keep
      regex: default;kubernetes;https

  # Node Exporter
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
    - role: node
    relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)

  # Nexus AI Services
  - job_name: 'nexus-ai-services'
    kubernetes_sd_configs:
    - role: endpoints
      namespaces:
        names:
        - nexus-ai
    relabel_configs:
    - source_labels: [__meta_kubernetes_service_name]
      target_label: service
    - source_labels: [__meta_kubernetes_namespace]
      target_label: namespace
    - source_labels: [__address__]
      target_label: __address__
      regex: (.+):(?:\d+)
      replacement: ${1}:8080
```

#### å‘Šè­¦è§„åˆ™ (nexus-ai-rules.yml)
```yaml
groups:
- name: nexus-ai-alerts
  rules:
  # æœåŠ¡å¯ç”¨æ€§å‘Šè­¦
  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.service }} is down"
      description: "Service {{ $labels.service }} has been down for more than 1 minute."

  # é«˜CPUä½¿ç”¨ç‡å‘Šè­¦
  - alert: HighCPUUsage
    expr: rate(container_cpu_usage_seconds_total[5m]) * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage on {{ $labels.pod }}"
      description: "CPU usage is above 80% for pod {{ $labels.pod }}."

  # é«˜å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
  - alert: HighMemoryUsage
    expr: container_memory_usage_bytes / container_spec_memory_limit_bytes * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage on {{ $labels.pod }}"
      description: "Memory usage is above 85% for pod {{ $labels.pod }}."

  # æ•°æ®åº“è¿æ¥å‘Šè­¦
  - alert: DatabaseConnectionHigh
    expr: pg_stat_activity_count > 80
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High database connections"
      description: "Database has {{ $value }} active connections."

  # APIå“åº”æ—¶é—´å‘Šè­¦
  - alert: APIResponseTimeHigh
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High API response time"
      description: "95th percentile response time is {{ $value }} seconds."
```

### 6.2 æ—¥å¿—é…ç½®

#### ELK Stacké…ç½®

**Elasticsearch (elasticsearch.yml)**
```yaml
cluster.name: nexus-ai-logs
network.host: 0.0.0.0
discovery.type: single-node
xpack.security.enabled: false
xpack.monitoring.collection.enabled: true
```

**Logstash (logstash.conf)**
```ruby
input {
  beats {
    port => 5044
  }
}

filter {
  if [kubernetes][namespace] == "nexus-ai" {
    json {
      source => "message"
    }
    
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    mutate {
      add_field => { "environment" => "%{[kubernetes][namespace]}" }
      add_field => { "service_name" => "%{[kubernetes][labels][app]}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "nexus-ai-%{+YYYY.MM.dd}"
  }
}
```

**Kibana (kibana.yml)**
```yaml
server.name: kibana
server.host: "0.0.0.0"
elasticsearch.hosts: ["http://elasticsearch:9200"]
logging.dest: stdout
```

---

## 7. å¤‡ä»½ä¸æ¢å¤

### 7.1 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

#### scripts/backup.sh
```bash
#!/bin/bash
set -e

# é…ç½®å˜é‡
NAMESPACE=${1:-nexus-ai}
BACKUP_DIR="/backups/nexus-ai"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

echo "ğŸ”„ Starting backup for namespace: $NAMESPACE"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½PostgreSQLæ•°æ®åº“
echo "ğŸ’¾ Backing up PostgreSQL databases..."
kubectl exec -n $NAMESPACE deployment/postgresql -- pg_dumpall -U nexus | gzip > $BACKUP_DIR/postgres_$DATE.sql.gz

# å¤‡ä»½Redisæ•°æ®
echo "ğŸ’¾ Backing up Redis data..."
kubectl exec -n $NAMESPACE deployment/redis -- redis-cli --rdb - | gzip > $BACKUP_DIR/redis_$DATE.rdb.gz

# å¤‡ä»½Elasticsearchæ•°æ®
echo "ğŸ’¾ Backing up Elasticsearch data..."
kubectl exec -n $NAMESPACE deployment/elasticsearch -- curl -X POST "localhost:9200/_snapshot/backup/snapshot_$DATE?wait_for_completion=true"

# å¤‡ä»½MinIOæ•°æ®
echo "ğŸ’¾ Backing up MinIO data..."
kubectl exec -n $NAMESPACE deployment/minio -- tar -czf /tmp/minio_$DATE.tar.gz /data
kubectl cp $NAMESPACE/minio-0:/tmp/minio_$DATE.tar.gz $BACKUP_DIR/

# å¤‡ä»½Kubernetesèµ„æº
echo "ğŸ’¾ Backing up Kubernetes resources..."
kubectl get all -n $NAMESPACE -o yaml > $BACKUP_DIR/kubernetes_$DATE.yaml

# æ¸…ç†æ—§å¤‡ä»½
echo "ğŸ—‘ï¸  Cleaning up old backups..."
find $BACKUP_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ (å¯é€‰)
if [ ! -z "$CLOUD_STORAGE_BUCKET" ]; then
    echo "â˜ï¸  Uploading backups to cloud storage..."
    aws s3 cp $BACKUP_DIR/ s3://$CLOUD_STORAGE_BUCKET/nexus-ai-backups/ --recursive
fi

echo "âœ… Backup completed successfully!"
echo "ğŸ“ Backup location: $BACKUP_DIR"
echo "ğŸ“Š Backup size: $(du -sh $BACKUP_DIR | cut -f1)"
```

### 7.2 æ¢å¤è„šæœ¬

#### scripts/restore.sh
```bash
#!/bin/bash
set -e

# é…ç½®å˜é‡
NAMESPACE=${1:-nexus-ai}
BACKUP_DATE=${2:-$(date +%Y%m%d_%H%M%S)}
BACKUP_DIR="/backups/nexus-ai"

echo "ğŸ”„ Starting restore for namespace: $NAMESPACE from backup: $BACKUP_DATE"

# ç¡®è®¤æ“ä½œ
read -p "âš ï¸  This will overwrite existing data. Are you sure? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Restore cancelled."
    exit 1
fi

# åœæ­¢æœåŠ¡
echo "â¸ï¸  Stopping services..."
kubectl scale deployment --all -n $NAMESPACE --replicas=0

# æ¢å¤PostgreSQLæ•°æ®åº“
echo "ğŸ’¾ Restoring PostgreSQL databases..."
gunzip -c $BACKUP_DIR/postgres_$BACKUP_DATE.sql.gz | kubectl exec -i -n $NAMESPACE deployment/postgresql -- psql -U nexus

# æ¢å¤Redisæ•°æ®
echo "ğŸ’¾ Restoring Redis data..."
gunzip -c $BACKUP_DIR/redis_$BACKUP_DATE.rdb.gz | kubectl exec -i -n $NAMESPACE deployment/redis -- redis-cli --pipe

# æ¢å¤MinIOæ•°æ®
echo "ğŸ’¾ Restoring MinIO data..."
kubectl cp $BACKUP_DIR/minio_$BACKUP_DATE.tar.gz $NAMESPACE/minio-0:/tmp/minio_backup.tar.gz
kubectl exec -n $NAMESPACE deployment/minio -- tar -xzf /tmp/minio_backup.tar.gz -C /

# é‡å¯æœåŠ¡
echo "â–¶ï¸  Restarting services..."
kubectl scale deployment --all -n $NAMESPACE --replicas=1

# ç­‰å¾…æœåŠ¡å°±ç»ª
echo "â³ Waiting for services to be ready..."
kubectl wait --for=condition=available --timeout=300s deployment --all -n $NAMESPACE

echo "âœ… Restore completed successfully!"
echo "ğŸŒ Services should be available shortly."
```

---

## 8. å®‰å…¨é…ç½®

### 8.1 ç½‘ç»œå®‰å…¨

#### NetworkPolicy
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nexus-ai-network-policy
  namespace: nexus-ai
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  - from:
    - podSelector:
        matchLabels:
          component: nexus-ai
    ports:
    - protocol: TCP
      port: 3000
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 9200
  egress:
  - to: []
    ports:
    - protocol: TCP
      port: 53    # DNS
    - protocol: UDP
      port: 53    # DNS
    - protocol: TCP
      port: 443   # HTTPS
    - protocol: TCP
      port: 80    # HTTP
```

### 8.2 Podå®‰å…¨

#### PodSecurityPolicy
```yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: nexus-ai-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

---

## 9. æ•…éšœæ’é™¤

### 9.1 å¸¸è§é—®é¢˜

#### Podæ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n nexus-ai

# æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod <pod-name> -n nexus-ai

# æŸ¥çœ‹Podæ—¥å¿—
kubectl logs <pod-name> -n nexus-ai

# æŸ¥çœ‹äº‹ä»¶
kubectl get events -n nexus-ai --sort-by='.lastTimestamp'
```

#### æœåŠ¡æ— æ³•è®¿é—®
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get services -n nexus-ai

# æ£€æŸ¥ç«¯ç‚¹
kubectl get endpoints -n nexus-ai

# æµ‹è¯•æœåŠ¡è¿é€šæ€§
kubectl run test-pod --image=curlimages/curl -i --rm --restart=Never -- curl -v http://service-name.namespace
```

#### å­˜å‚¨é—®é¢˜
```bash
# æŸ¥çœ‹PVCçŠ¶æ€
kubectl get pvc -n nexus-ai

# æŸ¥çœ‹å­˜å‚¨ç±»
kubectl get storageclass

# æŸ¥çœ‹å·è¯¦æƒ…
kubectl describe pvc <pvc-name> -n nexus-ai
```

### 9.2 æ€§èƒ½è°ƒä¼˜

#### èµ„æºé™åˆ¶è°ƒä¼˜
```yaml
# æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´èµ„æºé™åˆ¶
resources:
  limits:
    cpu: 2000m        # å¢åŠ CPUé™åˆ¶
    memory: 2Gi       # å¢åŠ å†…å­˜é™åˆ¶
  requests:
    cpu: 1000m       # å¢åŠ CPUè¯·æ±‚
    memory: 1Gi       # å¢åŠ å†…å­˜è¯·æ±‚
```

#### JVMè°ƒä¼˜ (å¦‚æœä½¿ç”¨JavaæœåŠ¡)
```yaml
env:
- name: JAVA_OPTS
  value: >-
    -Xms512m
    -Xmx2g
    -XX:+UseG1GC
    -XX:MaxGCPauseMillis=200
    -XX:+PrintGCDetails
    -XX:+PrintGCTimeStamps
```

---

## 10. æœ€ä½³å®è·µ

### 10.1 éƒ¨ç½²æœ€ä½³å®è·µ

1. **ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶**: æ‰€æœ‰é…ç½®æ–‡ä»¶éƒ½åº”çº³å…¥ç‰ˆæœ¬æ§åˆ¶
2. **ç¯å¢ƒéš”ç¦»**: ä¸¥æ ¼åŒºåˆ†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒ
3. **æ¸è¿›å¼éƒ¨ç½²**: ä½¿ç”¨è“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°
4. **å¥åº·æ£€æŸ¥**: ä¸ºæ‰€æœ‰æœåŠ¡é…ç½®é€‚å½“çš„å¥åº·æ£€æŸ¥
5. **èµ„æºé™åˆ¶**: è®¾ç½®åˆç†çš„CPUå’Œå†…å­˜é™åˆ¶
6. **è‡ªåŠ¨æ‰©ç¼©å®¹**: æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´Podæ•°é‡

### 10.2 å®‰å…¨æœ€ä½³å®è·µ

1. **æœ€å°æƒé™åŸåˆ™**: ä½¿ç”¨RBACé™åˆ¶è®¿é—®æƒé™
2. **ç½‘ç»œéš”ç¦»**: ä½¿ç”¨NetworkPolicyé™åˆ¶ç½‘ç»œæµé‡
3. **å¯†é’¥ç®¡ç†**: ä½¿ç”¨Kubernetes Secretç®¡ç†æ•æ„Ÿä¿¡æ¯
4. **é•œåƒå®‰å…¨**: ä½¿ç”¨å¯ä¿¡çš„é•œåƒæºï¼Œå®šæœŸæ‰«ææ¼æ´
5. **åŠ å¯†ä¼ è¾“**: ä½¿ç”¨TLSåŠ å¯†æ‰€æœ‰é€šä¿¡
6. **å®šæœŸå®¡è®¡**: å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å®‰å…¨é…ç½®

### 10.3 è¿ç»´æœ€ä½³å®è·µ

1. **ç›‘æ§å‘Šè­¦**: å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
2. **æ—¥å¿—æ”¶é›†**: é›†ä¸­æ”¶é›†å’Œç®¡ç†æ‰€æœ‰æœåŠ¡æ—¥å¿—
3. **å¤‡ä»½æ¢å¤**: å®šæœŸå¤‡ä»½å¹¶æµ‹è¯•æ¢å¤æµç¨‹
4. **æ–‡æ¡£ç»´æŠ¤**: ä¿æŒæ–‡æ¡£æ›´æ–°å’Œå‡†ç¡®æ€§
5. **è‡ªåŠ¨åŒ–**: å°½å¯èƒ½è‡ªåŠ¨åŒ–è¿ç»´æ“ä½œ
6. **æ¼”ç»ƒæµ‹è¯•**: å®šæœŸè¿›è¡Œæ•…éšœæ¢å¤æ¼”ç»ƒ

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2024å¹´12æœˆ2æ—¥*  
*ä¸‹æ¬¡è¯„å®¡: 2024å¹´12æœˆ16æ—¥*  
*çŠ¶æ€: å·²å®¡æ ¸*  
*è´Ÿè´£äºº: DevOpså›¢é˜Ÿ*